<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
<meta property="og:type" content="website">
<meta property="og:title" content="Semaik.">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Semaik.">
<meta property="og:description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Semaik.">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Semaik.</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Semaik." type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Semaik.</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技术博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/18/Tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/18/Tomcat/" class="post-title-link" itemprop="url">Tomcat</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-18 19:02:00" itemprop="dateCreated datePublished" datetime="2020-09-18T19:02:00+08:00">2020-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-25 10:52:13" itemprop="dateModified" datetime="2020-09-25T10:52:13+08:00">2020-09-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <h5 id="Tomcat-是什么"><a href="#Tomcat-是什么" class="headerlink" title="Tomcat 是什么?"></a>Tomcat 是什么?</h5><p>Tomcat 由JAVA语言开发的Java容器，实现了对 Servlet 和 JSP 的支持，并提供了作为Web服务器的一些特有功能，Tomcat是一种类似于IIS、Apache Http的Web服务端程序， Tomcat 本身也内含了一个 HTTP 服务器，它也可以被视作一个单独的 Web 服务器。也就是Web容器。</p>
<p>Servlet：是应用在服务端的小程序，由JAVA语言编写，本身支持各种JAVA相关的请求，但是大多用于接收web服务发来的请求，与数据库交互并将响应交给web服务</p>
<p>JDK：JAVA开发工具包。</p>
<p>常用工具：</p>
<blockquote>
<p>Java：运行编译后的类文件</p>
</blockquote>
<blockquote>
<p>Jar：对类文件进行打包</p>
</blockquote>
<blockquote>
<p>Javac：对源文件中的注释提取文档</p>
</blockquote>
<blockquote>
<p>Jconsole：远程连接工具</p>
</blockquote>
<blockquote>
<p>Jre：JAVA运行环境</p>
</blockquote>
<h5 id="部署tomcat"><a href="#部署tomcat" class="headerlink" title="部署tomcat"></a>部署tomcat</h5><p>配置Java环境</p>
<p>解压软件包</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">tar</span> <span class="selector-tag">zxf</span> <span class="selector-tag">jdk-8u201-linux-x64</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p>将jdk解压后的目录移动到/usr/local/起名为java</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mv <span class="regexp">/root/</span>jdk1.<span class="number">8.0</span>_201<span class="regexp">/ /u</span>sr<span class="regexp">/local/</span>java</span><br></pre></td></tr></table></figure>
<p>删除原先的旧java</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rm -rf <span class="regexp">/usr/</span>bin/java</span><br></pre></td></tr></table></figure>
<p>配置Java环境变量</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo &#x27;export JAVA_HOME=/usr/local/java</span></span><br><span class="line"><span class="comment"># 设置jre（Jave Runtime Environment：java运行时环境）的安装目录变量</span></span><br><span class="line">&gt; <span class="builtin-name">export</span> <span class="attribute">JRE_HOME</span>=/usr/local/java/jre/</span><br><span class="line"><span class="comment"># 设置类文件路径，冒号代表加的意思，引用以上设置的变量</span></span><br><span class="line">&gt; <span class="builtin-name">export</span> <span class="attribute">CLASSPATH</span>=<span class="variable">$JAVA_HOME</span>/lib:$JRE_HOME/lib</span><br><span class="line"><span class="comment"># 最后一行，相当于windows系统的命令环境变量，就是新添了两个java以及jre的命令变量</span></span><br><span class="line"><span class="comment"># $PATH代表原有的环境变量，使用变量复用</span></span><br><span class="line">&gt; <span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:$JAVA_HOME/bin:$JRE_HOME/bin&#x27; &gt;&gt; /etc/profile</span><br></pre></td></tr></table></figure>
<p>加载编写的profile文件</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">source</span> <span class="regexp">/etc/</span>profile</span><br></pre></td></tr></table></figure>
<p>查看版本号</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">&quot;1.8.0_201&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_201-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit<span class="built_in"> Server </span>VM (build 25.201-b09, mixed mode)</span><br></pre></td></tr></table></figure>
<p>安装Tomcat</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> zxf apache-tomcat-<span class="number">8</span>.<span class="number">5</span>.<span class="number">35</span>.tar.gz </span><br><span class="line"><span class="attribute">mv</span> apache-tomcat-<span class="number">8</span>.<span class="number">5</span>.<span class="number">35</span> /usr/local/tomcat</span><br></pre></td></tr></table></figure>
<p>启动服务：<code>/usr/local/tomcat/bin/startup.sh</code></p>
<p>停止服务：<code>/usr/local/tomcat/bin/shutdown.sh</code></p>
<blockquote>
<p>8080：接收客户端请求</p>
</blockquote>
<blockquote>
<p>8005：用于接收shutdown指令</p>
</blockquote>
<blockquote>
<p>8009：用于tomcat接受其他web服务发来的请求</p>
</blockquote>
<p>server.xml主配置文件</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/tomcat/conf/server.xml</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span></span><br><span class="line">port：server模块监听的端口号，可以自定义，只有端口号不冲突，为-<span class="number">1</span>时表示不接受关闭指令</span><br><span class="line">shutdown：server模块接收到的参数指定的指令时就关闭tomcat程序</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span></span><br><span class="line">name：指定该servie的名字，可以有多个service通过名字来区分</span><br><span class="line"></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span></span><br><span class="line">           connectionTimeout=<span class="string">&quot;20000&quot;</span></span><br><span class="line">           redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;&lt;/Connector&gt;</span><br><span class="line">&lt;Connector port=<span class="string">&quot;8009&quot;</span> protocol=<span class="string">&quot;AJP/1.3&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br><span class="line">port：tomcat对客户端开放的端口号，<span class="number">8080</span>是用于接收客户端发送的http请求，<span class="number">8009</span>是用于tomcat接受其他web服务发来的请求</span><br><span class="line">protocol：客户端连接tomcat使用的协议，AJP协议用于tomcat与其他web服务建立连接使用的</span><br><span class="line">connectionTimeout：与tomcat的连接超时时间，单位毫秒</span><br><span class="line">redirectPort：当tomcat配置为https时，如果客户端仍然使用http协议访问，强制对客户端使用的协议转换为https，并将端口转换为<span class="number">8443</span></span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span></span><br><span class="line">name：该engine的名字，如果有多个service用来区分不同的引擎，并在日志中通过 名字进行标识</span><br><span class="line"><span class="keyword">default</span> Host：引擎接受请求通过客户端请求的URL的IP/域名/主机名部分匹配Host模块，如果没有匹配到的则把请求交给defaultHost指定的主机处理，所以必须要有一个Host模块的主机名为defaultHost指定的名字</span><br><span class="line"></span><br><span class="line">&lt;Host<span class="built_in"> name</span>=<span class="string">&quot;localhost&quot;</span>  appBase=<span class="string">&quot;webapps&quot;</span></span><br><span class="line">          unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;Context<span class="built_in"> path</span>=”/test” docBase=”/haha”&gt;&lt;/Context&gt;</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line">name：该host也就是虚拟主机对应的名字，用来engine对客户端访问的url中的主机部分进行匹配</span><br><span class="line">appBase：该虚拟主机对应的站点目录，webapps是一个相对路径，其绝对路径为“/usr/local/tomcat/webapps”</span><br><span class="line">path：客户端访问的URL指定的名字如果是/test那么客户端要找的数据对应的位置就在/haha目录下</span><br><span class="line">docBase：web应用存放位置</span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">               prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">               pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">Directory：指定访问日志存放的位置，logs是相对路径，绝对路径为“/usr/local/tomcat/logs”</span><br><span class="line">Prefix：指定访问日志文件的前缀</span><br><span class="line">Suffix：指定访问日志文件的后缀</span><br><span class="line">Pattern：指定日志文件的格式</span><br><span class="line">- <span class="meta">%h</span>：记录发送该请求的主机的IP地址，可能是客户端的IP，可能是代理服务器的IP（谁最终将请求交给tomcat，这里就是谁的IP）</span><br><span class="line">- <span class="meta">%l</span>：记录该请求使用的逻辑用户，如果没有就用-表示</span><br><span class="line">- <span class="meta">%u</span>：记录该请求的真实用户，如果没有则用-表示</span><br><span class="line">- <span class="meta">%t</span>：记录该请求的发送时间</span><br><span class="line">- <span class="meta">%quot</span>；：表示“”引号</span><br><span class="line">- <span class="meta">%r</span>：记录请求的请求行</span><br><span class="line">- <span class="meta">%s</span>：记录对该请求响应的状态码	</span><br><span class="line">- <span class="meta">%b</span>：记录该请求相应的字节数</span><br><span class="line">- <span class="meta">%D</span>：记录该请求响应的时间，可以用来测试tomcat的性能</span><br></pre></td></tr></table></figure>
<h5 id="Tomcat多实例"><a href="#Tomcat多实例" class="headerlink" title="Tomcat多实例"></a>Tomcat多实例</h5><blockquote>
<p>通过修改不同tomcat结点的配置文件中的端口来启动不同的tomcat实例</p>
</blockquote>
<p>示例一：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> zxf apache-tomcat-<span class="number">8</span>.<span class="number">5</span>.<span class="number">33</span>.tar.gz</span><br><span class="line"><span class="attribute">cp</span> /root/apache-tomcat-<span class="number">8</span>.<span class="number">5</span>.<span class="number">33</span> /usr/local/tomcat</span><br><span class="line"><span class="attribute">sh</span> /usr/local/tomcat/bin/startup.sh		//启动第一个实例</span><br><span class="line"><span class="attribute">netstat</span> -anpt | grep java		//查看到监听了三个端口<span class="number">8080</span>、<span class="number">8005</span>、<span class="number">8009</span></span><br></pre></td></tr></table></figure>
<p>示例二：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="regexp">/root/</span>apache-tomcat<span class="number">-8.5</span><span class="number">.33</span> <span class="regexp">/usr/</span>local/tomcat2</span><br><span class="line">vim <span class="regexp">/usr/</span>local<span class="regexp">/tomcat2/</span>conf/server.xml</span><br><span class="line">修改：</span><br><span class="line">&lt;Server port=<span class="string">&quot;8006&quot;</span> shutdown=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;		<span class="comment">//修改接收shutdown指令的端口</span></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8081&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span>		<span class="comment">//修改接收客户端请求的端口</span></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8010&quot;</span> protocol=<span class="string">&quot;AJP/1.3&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> <span class="regexp">/&gt;		/</span>/修改接收其他web服务发送请求的端口</span><br><span class="line">sh <span class="regexp">/usr/</span>local<span class="regexp">/tomcat2/</span>bin<span class="regexp">/startup.sh		/</span>/启动第二个实例</span><br><span class="line">netstat -anpt | grep java		<span class="comment">//可以看到实例二所监听的端口8081、8006、8010</span></span><br></pre></td></tr></table></figure>
<h6 id="验证："><a href="#验证：" class="headerlink" title="验证："></a>验证：</h6><p>通过访问这两个tomcat节点，可以在这两个节点的站点目录下添加不同的文件来访问</p>
<p>添加示例一测试文件：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/usr/</span>local<span class="regexp">/tomcat/</span>webapps/<span class="number">1</span></span><br><span class="line">echo wo shi shi li yi &gt; <span class="regexp">/usr/</span>local<span class="regexp">/tomcat/</span>webapps<span class="regexp">/1/</span><span class="number">1</span>.jsp</span><br></pre></td></tr></table></figure>
<p>添加示例二测试文件：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="regexp">/usr/</span>local<span class="regexp">/tomcat2/</span>webapps/<span class="number">2</span></span><br><span class="line">echo wo shi shi li er &gt; <span class="regexp">/usr/</span>local<span class="regexp">/tomcat2/</span>webapps<span class="regexp">/2/</span><span class="number">2</span>.jsp</span><br></pre></td></tr></table></figure>
<p>访问：<br><img src="/images/timg2.png" alt="upload successful"></p>
<h5 id="Tomcat多虚拟主机"><a href="#Tomcat多虚拟主机" class="headerlink" title="Tomcat多虚拟主机"></a>Tomcat多虚拟主机</h5><p>在hosts文件中添加域名</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/hosts</span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-41.png" alt="upload successful"></p>
<p>再一个tomcat实例中添加多个Host模块，匹配多个站点目录供客户端访问</p>
<p>修改server.xml主配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/local/tomcat/conf/server.xml</span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-42.png" alt="upload successful"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Host name=&quot;www.one.com&quot; appBase=&quot;/one&quot;&gt;&lt;/Host&gt;		//客户端如果访问的url域名为www.one.com，则匹配的站点目录为/one</span><br><span class="line">        &lt;Host name=<span class="string">&quot;www.two.com&quot;</span> appBase=<span class="string">&quot;/two&quot;</span>&gt;		<span class="comment">//客户端如果访问的url域名为www.two.com，则匹配的站点目录为/two</span></span><br><span class="line">        &lt;/Host&gt;</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; sh /usr/local/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<p>创建站点目录/one和/two，并添加web应用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p /one/o</span><br><span class="line"># echo one &gt; /one/o/aa.jsp</span><br><span class="line"># mkdir -p /two/t</span><br><span class="line"># echo two &gt; /two/t/bb.jsp</span><br></pre></td></tr></table></figure>
<p>在默认的webapps站点目录下创建目录cc，并添加web应用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir /usr/local/tomcat/webapps/three</span><br><span class="line"># echo nin ben ci fang wen de ye mian lai zi zhan dian mu lu wei webapps xia &gt; /usr/local/tomcat/webapps/three/cc.jsp</span><br></pre></td></tr></table></figure>
<p>验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># curl www.one.com:8080/o/aa.jsp</span><br><span class="line">one</span><br><span class="line"># curl www.two.com:8080/t/bb.jsp</span><br><span class="line">two</span><br></pre></td></tr></table></figure>
<p>访问<a target="_blank" rel="noopener" href="http://www.three.com:8080/three/cc.jsp%60%EF%BC%88%E6%9C%AC%E6%AC%A1%E8%AE%BF%E9%97%AE%E7%9A%84url%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E6%B2%A1%E6%9C%89%E6%8C%87%E5%AE%9A%E5%9F%9F%E5%90%8D%E6%89%80%E5%AF%B9%E5%BA%94%E7%9A%84%E7%AB%99%E7%82%B9%E7%9B%AE%E5%BD%95%EF%BC%8C%E6%89%80%E4%BB%A5%E8%AE%BF%E9%97%AE%E8%AF%A5%E5%9F%9F%E5%90%8D%E7%9A%84%E5%86%85%E5%AE%B9%E6%9D%A5%E8%87%AAtomcat%E9%BB%98%E8%AE%A4%E7%9A%84%E7%AB%99%E7%82%B9%E7%9B%AE%E5%BD%95webapps%E4%B8%8B%E7%9A%84three%E7%9A%84web%E5%BA%94%E7%94%A8%EF%BC%89%60">www.three.com:8080/three/cc.jsp`（本次访问的url在配置文件中没有指定域名所对应的站点目录，所以访问该域名的内容来自tomcat默认的站点目录webapps下的three的web应用）`</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># curl www.three.com:8080/three/cc.jsp</span><br><span class="line">nin ben ci fang wen de ye mian lai zi zhan dian mu lu wei webapps xia</span><br></pre></td></tr></table></figure>

<h5 id="自定义web应用的访问位置"><a href="#自定义web应用的访问位置" class="headerlink" title="自定义web应用的访问位置"></a>自定义web应用的访问位置</h5><p>修改配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/local/tomcat/conf/server.xml</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-44.png" alt="upload successful"></p>
<blockquote>
<p>如果客户端访问的url中域名为<a target="_blank" rel="noopener" href="http://www.two.com则匹配到的站点目录为/two">www.two.com则匹配到的站点目录为/two</a><br>如果客户端访问的url中域名为<a target="_blank" rel="noopener" href="http://www.two.com:8080/myself%EF%BC%8C%E5%88%99%E5%8C%B9%E9%85%8D%E7%9A%84%E7%AB%99%E7%82%B9%E7%9B%AE%E5%BD%95%E4%B8%BA/self">www.two.com:8080/myself，则匹配的站点目录为/self</a></p>
</blockquote>
<p>重启服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; sh /usr/local/tomcat/bin/startup.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>创建/self站点目录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir /self</span><br><span class="line"># echo this is myself &gt; /self/self.jsp</span><br></pre></td></tr></table></figure>
<p>访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># curl www.two.com:8080/t/bb.jsp</span><br><span class="line">two</span><br><span class="line"># curl www.two.com:8080/myself/self.jsp</span><br><span class="line">myself</span><br></pre></td></tr></table></figure>
<h5 id="编写内存测试页面"><a href="#编写内存测试页面" class="headerlink" title="编写内存测试页面"></a>编写内存测试页面</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir /one/memtest</span><br><span class="line">vim /one/memtest/meminfo.jsp</span><br><span class="line">&lt;%</span><br><span class="line">Runtime rtm = Runtime.getRuntime();		# 获取运行时间</span><br><span class="line">long mm = rtm.maxMemory()/1024/1024;	# 给JVM分配的最大内存</span><br><span class="line">long tm = rtm.totalMemory()/1024/1024;	# Java程序用掉的JVM内存</span><br><span class="line">long fm = rtm.freeMemory()/1024/1024;	# 给JVM分配完后剩余的内存</span><br><span class="line"></span><br><span class="line">out.println(<span class="string">&quot;memory info:&lt;br&gt;&quot;</span>);</span><br><span class="line">out.println(<span class="string">&quot;jvm max memory:&quot;</span>+mm+<span class="string">&quot;MB&quot;</span>+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">out.println(<span class="string">&quot;jvm used:&quot;</span>+tm+<span class="string">&quot;MB&quot;</span>+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">out.println(<span class="string">&quot;system free:&quot;</span>+fm+<span class="string">&quot;MB&quot;</span>+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">out.println(<span class="string">&quot;can be used:&quot;</span>+(mm+fm-tm)+<span class="string">&quot;MB&quot;</span>+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>访问测试：</p>
<p><img src="/images/pasted-45.png" alt="upload successful"></p>
<h5 id="远程监控tomcat性能"><a href="#远程监控tomcat性能" class="headerlink" title="远程监控tomcat性能"></a>远程监控tomcat性能</h5><p>编写脚本</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/local/tomcat/bin/catalina.sh</span><br><span class="line">添加：（<span class="number">309</span>行）</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Djava.rmi.server.hostname=1.1.1.1&quot;	# 指定被连接的主机的IP/主机名/域名</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote.port=9000&quot;	# 指定被连接的主机的端口</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote.authenticate=true&quot;	# 指定连接时使用的身份验证</span><br><span class="line">JAVA_OPTS=&quot;$JAVA_OPTS -Dcom.sun.management.jmxremote.ssl=false&quot;	# 指定连接时使用的身份验证</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-46.png" alt="upload successful"></p>
<p>设置用于远程连接的用户和密码</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cp <span class="regexp">/usr/</span>local<span class="regexp">/java/</span>jre<span class="regexp">/lib/m</span>anagement<span class="regexp">/jmxremote.password.template /u</span>sr<span class="regexp">/local/</span>java<span class="regexp">/jre/</span>lib<span class="regexp">/management/</span>jmxremote.password</span><br><span class="line"># vim  <span class="regexp">/usr/</span>local<span class="regexp">/java/</span>jre<span class="regexp">/lib/m</span>anagement/jmxremote.password</span><br><span class="line">取消注释：</span><br><span class="line"> 用户名		  密码</span><br><span class="line">monitorRole		<span class="number">123456</span></span><br><span class="line">controlRole		<span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>对password文件提权</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod 600 /usr/local/java/jre/lib/management/jmxremote.password</span><br></pre></td></tr></table></figure>
<p>重启服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; /usr/local/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-47.png" alt="upload successful"></p>
<p>放行防火墙（不行就关闭防火墙）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># firewall-cmd --add-port=8080/tcp</span><br><span class="line"># firewall-cmd --add-port=8005/tcp</span><br><span class="line"># firewall-cmd --add-port=8009/tcp</span><br><span class="line"># firewall-cmd --add-port=9000/tcp</span><br><span class="line"># setenforce 0</span><br></pre></td></tr></table></figure>
<p>打开一台虚拟机（只需要部署JDK）</p>
<p>远程连接</p>
<p>jconsole</p>
<p><img src="/images/pasted-48.png" alt="upload successful"></p>
<p><img src="/images/pasted-49.png" alt="upload successful"></p>
<p><img src="/images/pasted-50.png" alt="upload successful"></p>
<h5 id="自定义错误页面"><a href="#自定义错误页面" class="headerlink" title="自定义错误页面"></a>自定义错误页面</h5><p>初次访问一个不存在的错误页面结果</p>
<p><img src="/images/pasted-51.png" alt="upload successful"><br>修改web页面配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/local/tomcat/conf/web.xml</span><br><span class="line">添加：（<span class="number">117</span>行）</span><br><span class="line">&lt;error-page&gt;</span><br><span class="line">        &lt;error-code&gt;404&lt;/error-code&gt;</span><br><span class="line">        &lt;location&gt;/notfound.jsp&lt;/location&gt;	# 指定错误页面的文件</span><br><span class="line">&lt;/error-page&gt;</span><br></pre></td></tr></table></figure>
<p>编写要返回给客户端的错误页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/local/tomcat/webapps/ROOT/notfound.jsp</span><br><span class="line">Not Found！</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd /usr/local/tomcat/bin/</span><br><span class="line"># ./shutdown.sh</span><br><span class="line"># ./startup.sh</span><br></pre></td></tr></table></figure>
<p>如提示报错：（显示地址被占用）</p>
<p><img src="/images/pasted-53.png" alt="upload successful"></p>
<p><img src="/images/pasted-54.png" alt="upload successful"></p>
<p>直接杀死相关的进程号就OK！</p>
<p>kill -9 50831</p>
<p>再次关闭、启动就OK！</p>
<p>测试访问：（访问一个不存在的页面）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># curl 127.0.0.1:8080/zx.jsp</span><br><span class="line">Not Found!</span><br></pre></td></tr></table></figure>

<h5 id="通过web页面来管理虚拟主机"><a href="#通过web页面来管理虚拟主机" class="headerlink" title="通过web页面来管理虚拟主机"></a>通过web页面来管理虚拟主机</h5><p>将打包好的web应用bdqnweb.war拷贝到宿主目录下</p>
<p><img src="/images/pasted-55.png" alt="upload successful"></p>
<p>修改配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">取消注释并设置可访问管理界面的用户（最后）</span><br><span class="line"># vim /usr/local/tomcat/conf/tomcat-users.xml</span><br><span class="line">&lt;role rolename=&quot;admin-gui&quot;/&gt;	# 设置可以访问host-manager这个web应用的html的权限</span><br><span class="line">&lt;role rolename=&quot;admin-script&quot;/&gt;	# 设置可以访问txt类型页面的权限</span><br><span class="line">&lt;user username=&quot;aa&quot; password=&quot;123.com&quot; roles=&quot;admin-gui,admin-script&quot;/&gt;	# 添加用户aa密码为123.com，拥有admin-gui和admin-script两个权限</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; sh /usr/local/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<p>验证</p>
<blockquote>
<p>访问管理虚拟主机页面并添加虚拟主机</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firefox <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/host-manager</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-56.png" alt="upload successful"></p>
<p><img src="/images/pasted-57.png" alt="upload successful"></p>
<p><img src="/images/pasted-58.png" alt="upload successful"><br>创建<a target="_blank" rel="noopener" href="http://www.test.com域名所对应的站点目录,并添加web应用/">www.test.com域名所对应的站点目录，并添加web应用</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p /test/app1</span><br><span class="line"># echo www.test.com &gt; /test/app1/test.jsp</span><br></pre></td></tr></table></figure>
<p>修改hosts文件添加域名</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># echo &quot;1.1.1.1 www.test.com&quot; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<p>验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># curl www.test.com:8080/app1/test.jsp</span><br><span class="line">www.test.com</span><br></pre></td></tr></table></figure>
<p>设置允许其他地址访问<code>Host-manager管理界面</code>（<code>默认地址为127.0.0.1可访问</code>）</p>
<blockquote>
<p><u>如果使用本机的物理IP访问<strong>host-manager</strong>管理界面是不可以访问的因为在配置文件中没有指定其他IP访问管理界面，所以在配置文件中可以指定其他IP允许访问管理界面</u></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/tomcat/webapps/host-manager/META-INF/context.xml</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-59.png" alt="upload successful"></p>
<blockquote>
<p>在正则表达式里面“点”为任意所有的意思，所以在这里需要用“\”这个符号进行转义（<code>^.*$代表允许所有地址可访问</code>）</p>
</blockquote>
<p>重启服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; sh /usr/local/tomcat/bin/startup.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firefox <span class="number">1.1</span>.<span class="number">1.1</span>:<span class="number">8080</span>/host-manager</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-60.png" alt="upload successful"></p>
<p><img src="/images/pasted-61.png" alt="upload successful"><br>访问成功！！！</p>
<blockquote>
<p><u>重启服务后在管理界面添加的虚拟主机域名会消失，因为重启后服务会读取配置文件中的数据，在管理界面添加的虚拟主机不记录在配置文件中，所以会消失，但是消失的虚拟主机所对应的数据还在，只是虚拟主机的域名不存在。</u></p>
</blockquote>
<blockquote>
<p>访问manager控制界面（如果虚拟主机和发布web应用一起做的话一起修改tomcat-users配置文件，如果先做虚拟主机在做发布web应用中间在重启服务，虚拟主机就会消失，建议一起修改配置文件）</p>
</blockquote>
<p>在配置文件中3yy，p复制粘贴这三行并修改</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/tomcat/conf/tomcat-users.xml</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;	# 设置可以访问manager这个web应用的html权限</span><br><span class="line">&lt;role rolename=&quot;manager-script&quot;/&gt;	# 设置可以访问txt类型页面的权限</span><br><span class="line">&lt;user username=&quot;bb&quot; password=&quot;123.com&quot; roles=&quot;manager-gui,manager-script&quot;/&gt;	# 添加可以访问的用户bb，密码为123.聪明，拥有manager-gui和manager-script两个权限 </span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-62.png" alt="upload successful"><br>重启服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; sh /usr/local/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<p>访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firefox <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/manager</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-63.png" alt="upload successful"></p>
<h6 id="第一种发布web应用方式"><a href="#第一种发布web应用方式" class="headerlink" title="第一种发布web应用方式"></a>第一种发布web应用方式</h6><p><img src="/images/pasted-64.png" alt="upload successful"></p>
<p><img src="/images/pasted-65.png" alt="upload successful"></p>
<p><img src="/images/pasted-68.png" alt="upload successful"><br><strong>发布成功后顶部显示OK</strong></p>
<p><img src="/images/pasted-69.png" alt="upload successful"></p>
<p>当然在tomcat的默认站点目录webapps下会生成一个bdqnweb应用</p>
<p><img src="/images/pasted-70.png" alt="upload successful"></p>
<p>访问bdqnweb应用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firefox <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/bdqnweb/</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-71.png" alt="upload successful"></p>
<h6 id="第二种发布方式"><a href="#第二种发布方式" class="headerlink" title="第二种发布方式"></a>第二种发布方式</h6><p><img src="/images/pasted-72.png" alt="upload successful"><br><strong>发布成功后顶部显示OK</strong></p>
<p><img src="/images/pasted-73.png" alt="upload successful"><br>/hello不需要在webapps目录下提前创建，发布成功后会自动生成</p>
<p><img src="/images/pasted-74.png" alt="upload successful"><br>访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># curl 127.0.0.1:8080/hello</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>
<p>设置允许其他地址访问<strong>manager</strong>管理界面（<code>默认地址为127.0.0.1可访问</code>）<br>修改配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/tomcat/webapps/manager/META-INF/context.xml</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-75.png" alt="upload successful"></p>
<p>*<em>（^.</em>$代表允许所有地址可访问）**</p>
<p>重启服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; sh /usr/local/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<p>验证访问</p>
<p><img src="/images/pasted-76.png" alt="upload successful"></p>
<p><img src="/images/pasted-77.png" alt="upload successful"></p>
<h5 id="JVM常用内存优化参数"><a href="#JVM常用内存优化参数" class="headerlink" title="JVM常用内存优化参数"></a>JVM常用内存优化参数</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/local/tomcat/bin/catalina.sh</span><br><span class="line">添加：</span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms512M -Xmx512M -XX:NewSize=300M -XX:OldSize=100M -XX:SurvivorRatio=2&quot;</span></span><br><span class="line">-Xms512：指定JVM初始化分配的内存</span><br><span class="line">-Xmx512：指定JVM最大获取到的内存</span><br><span class="line">-XX:NewSize=<span class="number">300</span>M：指定新生代的内存容量</span><br><span class="line">-XX:OldSize=<span class="number">100</span>M：指定年老代的内存容量</span><br><span class="line">-XX:SurvivorRatio=<span class="number">2</span>：指定Survivor与Eden的占比</span><br><span class="line">#-XX:PermSize：指定持久代的容量</span><br><span class="line">#-XX:PermMaxSize：指定持久代的最大容量</span><br><span class="line">#-XX:NewMaxSize：指定新生代的最大内存容量</span><br></pre></td></tr></table></figure>
<p>指定线程池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># vim /usr/local/tomcat/conf/server.xml</span><br><span class="line">修改：去掉注释（<span class="number">56</span>行）</span><br><span class="line">指定线程池，名字为threadpool，最大可开启线程数量为<span class="number">150</span>个，最下空闲进程数量<span class="number">4</span>个</span><br><span class="line">    &lt;Executor name=<span class="string">&quot;threadPool&quot;</span> namePrefix=<span class="string">&quot;catalina-exec-&quot;</span></span><br><span class="line">        maxThreads=<span class="string">&quot;150&quot;</span> minSpareThreads=<span class="string">&quot;4&quot;</span>/&gt;</span><br><span class="line">连接器引用指定名字对应的线程池</span><br><span class="line">    &lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span></span><br><span class="line">        executor=<span class="string">&quot;threadPool&quot;</span></span><br><span class="line">               connectionTimeout=<span class="string">&quot;20000&quot;</span></span><br><span class="line">               redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># sh /usr/local/tomcat/bin/shutdown.sh &amp;&amp; sh /usr/local/tomcat/bin/startup.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>验证访问</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># firefox www.new.com:8080/manager</span><br></pre></td></tr></table></figure>

<p><img src="/images/pasted-78.png" alt="upload successful"></p>
<p><img src="/images/pasted-79.png" alt="upload successful"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/18/Ansible%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/18/Ansible%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">Ansible常用模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-18 17:32:00 / 修改时间：20:46:08" itemprop="dateCreated datePublished" datetime="2020-09-18T17:32:00+08:00">2020-09-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index"><span itemprop="name">Ansible</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <h6 id="ping模块："><a href="#ping模块：" class="headerlink" title="ping模块："></a>ping模块：</h6><p>检测各主机之间的连接状况</p>
<p>如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ansible all -m ping</span></span><br></pre></td></tr></table></figure>
<h6 id="command模块："><a href="#command模块：" class="headerlink" title="command模块："></a>command模块：</h6><p>主要用于执行简单的shell命令：单个命令</p>
<p>如：ls、cat等类似简单命令，不带有管道符类似操作的使用shell模块</p>
<p>例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ansible dbserver -m command -a &#x27;ls /root&#x27;</span></span><br><span class="line"><span class="comment"># 配置主机清单时dbserver中，只写入了1.4，所以结果只有1.4主机运行ls /root</span></span><br><span class="line">192.168.1.4 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line">initial-setup-ks.cfg</span><br><span class="line">公共</span><br><span class="line">模板</span><br><span class="line">视频</span><br><span class="line">图片</span><br><span class="line">文档</span><br><span class="line">下载</span><br><span class="line">音乐</span><br><span class="line">桌面</span><br></pre></td></tr></table></figure>
<h6 id="shell模块"><a href="#shell模块" class="headerlink" title="shell模块"></a>shell模块</h6><p>执行linux复杂命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ansible dbserver -m shell -a &#x27;ls /root/ | wc -l&#x27;</span></span><br><span class="line">192.168.1.4 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">10</span><br></pre></td></tr></table></figure>
<h6 id="args"><a href="#args" class="headerlink" title="args"></a>args</h6><p>如果在编译安装包时，需要进入目录进行配置，使用以下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- shell: ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">  args:</span><br><span class="line">    <span class="built_in">chdir</span>: 解压包路径</span><br></pre></td></tr></table></figure>
<h6 id="cron模块"><a href="#cron模块" class="headerlink" title="cron模块"></a>cron模块</h6><p>执行计划任务，用于为被控制端设置自动化任务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 设置任务</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ansible dbserver -m cron -a &#x27;minute=&quot;*/2&quot; job=&quot;date &gt;&gt; /tmp/date.txt&quot; name=&quot;show date&quot; state=present&#x27;</span></span><br><span class="line">state=persent:一般表示新增</span><br><span class="line"><span class="comment"># 删除任务，只需要指定name即可</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ansible dbserver -m cron -a &#x27; name=&quot;show date&quot; state=absent&#x27;</span></span><br><span class="line">state=absent：一般表示移除，可以用来删除计划任务</span><br><span class="line"><span class="comment"># cron的其他关键字参考</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ansible-doc -s cron</span></span><br></pre></td></tr></table></figure>
<h6 id="user模块"><a href="#user模块" class="headerlink" title="user模块"></a>user模块</h6><p>常用操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">useradd 用户名		<span class="comment"># 创建普通用户</span></span><br><span class="line">passwd 用户名		<span class="comment"># 设置用户密码</span></span><br><span class="line">useradd -M -s /sbin/nologin 用户名		<span class="comment"># 创建的用户没有家目录，不能登录</span></span><br><span class="line">useradd -u 用户id -g gid 用户名   <span class="comment"># 创建用户时指定uid和gid</span></span><br><span class="line">userdel -r 用户			<span class="comment"># 连同用户家目录一起删除用户</span></span><br></pre></td></tr></table></figure>
<p>以上操作通过ansible来完成</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m user -a <span class="string">&#x27;name=用户名 state=present&#x27;</span>	<span class="comment"># 创建用户</span></span><br><span class="line"><span class="comment"># openssl passwd &quot;123.com&quot;用来获取加密后的密码</span></span><br><span class="line">ansible 操作对象 -m user -a <span class="string">&#x27;name=用户名 password=&quot;加密密码&quot; state=present&#x27;</span>   <span class="comment"># 创建用户并设置密码</span></span><br><span class="line">ansible 操作对象 -m shell -a <span class="string">&#x27;echo &quot;123.com&quot; | passwd --stdin 用户名&#x27;</span>   <span class="comment"># 设置用户密码</span></span><br><span class="line"><span class="comment"># 创建无家目录，不能登录的用户</span></span><br><span class="line">ansible 操作对象 -m user -a <span class="string">&#x27;name=用户名 create_home=no shell=/sbin/nologin state=present&#x27;</span>  </span><br><span class="line"><span class="comment"># 创建用户是指定uid和基本组</span></span><br><span class="line">ansible 操作对象 -m user -a <span class="string">&#x27;name=用户名 uid=id号 group=组名 state=present&#x27;</span></span><br><span class="line"><span class="comment"># 连同用户家目录一同删除</span></span><br><span class="line">ansible 操作对象 -m user -a <span class="string">&#x27;name=用户名 remove=yes state=absent&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="group模块"><a href="#group模块" class="headerlink" title="group模块"></a>group模块</h6><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">添加组</span><br><span class="line">ansible 操作对象 -m group -a <span class="string">&#x27;name=组名 system=yes state=present gid=ID号&#x27;</span></span><br><span class="line">system=yes：是否是公共组</span><br><span class="line">删除组</span><br><span class="line">ansible 操作对象 -m group -a <span class="string">&#x27;name=组名 state=absent&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h6><p>1、从主控端复制文件到被控端（类似scp）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m copy -a <span class="string">&#x27;src=主控端文件路径 dest=被控端保存路径&#x27;</span></span><br><span class="line"><span class="comment"># 在被控端查看是否复制文件成功</span></span><br><span class="line">ansible all -m shell -a <span class="string">&#x27;ls 被控端保存文件路径&#x27;</span></span><br></pre></td></tr></table></figure>
<p>2、主控端控制被控端复制和粘贴被控端的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m copy -a <span class="string">&#x27;src=被控端源文件路径 dest=被控端目标位置 remote_src=yes&#x27;</span></span><br><span class="line"><span class="comment"># 验证ansible的幂等性，remote_src=yes，当发现同文件名时，不执行此命令</span></span><br><span class="line">ansible 操作对象 -m copy -a <span class="string">&#x27;src=被控端源文件路径 dest=被控端目标位置 remote_src=yes backup=yes&#x27;</span></span><br><span class="line"><span class="comment"># 修改被控端/root/resolv.conf的内容，使其可以发生文件覆盖，此时在加上backup进行文件覆盖前的备份</span></span><br></pre></td></tr></table></figure>
<h6 id="file模块"><a href="#file模块" class="headerlink" title="file模块"></a>file模块</h6><p>1、修改文件属性（owner（属主） group（属组） mode（权限） 对应linux命令 chown chmod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 改变属主属组</span></span><br><span class="line">ansible 操作对象 -m file -a <span class="string">&#x27;path=被控端都存在的要修改属主属组的文件路径 owner=被控端都存在的用户 group=被控端都存在的组 recurse=yes&#x27;</span></span><br><span class="line"> recurse=yes：表示递归设置属主属组</span><br><span class="line"><span class="comment"># 修改文件权限</span></span><br><span class="line">ansible 操作对象 -m file -a <span class="string">&#x27;path=被控端存在的文件路径 mode=7777 recurse=yes&#x27;</span></span><br><span class="line"> 使用mnnn样式的四位8进制数表示，recurse=yes：对当前目录中的所有内容递归权限</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">2、软链接、硬链接</span><br><span class="line"></span><br><span class="line">```sh</span><br><span class="line"><span class="comment"># 软链接</span></span><br><span class="line">ansible 操作对象 -m file -a <span class="string">&#x27;src=被控端源文件 dest=软链接文件路径 state=link&#x27;</span></span><br><span class="line"><span class="comment"># 硬链接</span></span><br><span class="line">ansible 操作对象 -m file -a <span class="string">&#x27;src=被控端源文件 dest=硬链接文件路径 state=hard&#x27;</span></span><br></pre></td></tr></table></figure>
<p>3、创建文件和目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件</span></span><br><span class="line">ansible 操作对象 -m file -a <span class="string">&#x27;path=文件路径及文件名 state=touch&#x27;</span></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">ansible 操作对象 -m file -a <span class="string">&#x27;path=目录路径及目录名 state=directory&#x27;</span></span><br><span class="line"><span class="comment"># 删除文件或者目录</span></span><br><span class="line">ansible 操作对象 -m file -a <span class="string">&#x27;path=被控端删除文件或目录路径 state=absent&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="yum模块"><a href="#yum模块" class="headerlink" title="yum模块"></a>yum模块</h6><p>主控端控制被控端，使其使用yum安装rpm包</p>
<p>前提：被控端的yum可用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装rpm某包</span></span><br><span class="line">ansible 操作对象 -m yum -a <span class="string">&#x27;name=包名,包名1... state=installed/present    # 默认不写state是installed/present</span></span><br><span class="line"><span class="string"># 卸载rpm包</span></span><br><span class="line"><span class="string">ansible 操作对象 -m yum -a &#x27;</span>name=包名,包名1... state=removed/absent</span><br></pre></td></tr></table></figure>
<h6 id="service模块"><a href="#service模块" class="headerlink" title="service模块"></a>service模块</h6><p>操控被控端开启、关闭、重启、重载（视具体服务而定）</p>
<p>notice：service可用管理rpm包安装的服务，源码安装的服务建议使用shell模块直接打命令</p>
<p>服务状态：started/stopped/restarted/reloaded</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m service -a <span class="string">&#x27;name=服务名 state=服务状态&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="hostname模块"><a href="#hostname模块" class="headerlink" title="hostname模块"></a>hostname模块</h6><p>修改主机名操作</p>
<p>hostname 主机名 临时</p>
<p>hostnamectl set-hostname 主机名 永久</p>
<p>vim /etc/hosts 修改配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m hostname -a <span class="string">&#x27;name=主机名&#x27;</span></span><br></pre></td></tr></table></figure>

<h6 id="script模块"><a href="#script模块" class="headerlink" title="script模块"></a>script模块</h6><p>用于将主控端的脚本在被控端执行，shell脚本和python脚本</p>
<p>写一个简单创建用户的脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">!/bin/bash</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        useradd user<span class="variable">$i</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&#x27;123.com&#x27;</span> | passwd --stdin user<span class="variable">$i</span></span><br><span class="line">    <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>添加脚本可执行权限</p>
<p><code>chmod +x users.sh </code><br>使用script模块执行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line">ansible 操作对象 -m script -a <span class="string">&#x27;脚本文件在主控端的路径&#x27;</span></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">ansible 操作对象 -m shell -a <span class="string">&#x27;tail /etc/passwd&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="setup模块"><a href="#setup模块" class="headerlink" title="setup模块"></a>setup模块</h6><p>用于获取被控端的ansible变量值，主要用于模板剧本中，可以利用变量，实现对被控端的快速配置和差异化配置</p>
<p>ansible变量：用于记录所有主控端和被控端的连接信息</p>
<p>ansible dbserver -m setup 查看所有的变量值</p>
<p>常用选项：ansible 操作对象 -m setup -a ‘filter=”<em>变量关键字</em>“‘ filter用于筛选变量</p>
<p>如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关于cpu的变量</span></span><br><span class="line">ansible dbserver -m setup -a <span class="string">&#x27;filter=&quot;*cpu*&quot;&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="fetch模块"><a href="#fetch模块" class="headerlink" title="fetch模块"></a>fetch模块</h6><p>拿取被控端文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存放时，会将每台被控端创建一个ip目录</span></span><br><span class="line">ansible 操作对象 -m fetch -a <span class="string">&#x27;src=被控端文件路径 dest=主控端存放路径&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="replace模块"><a href="#replace模块" class="headerlink" title="replace模块"></a>replace模块</h6><p>可以实现对文件内容的替换</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 替换文件中所有匹配的字符</span></span><br><span class="line">ansible dbserver -m replace -a <span class="string">&#x27;path=被控端文件路径 regexp=&#x27;</span>匹配要替换的字符<span class="string">&#x27; replace=&#x27;</span>替换后的字符<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 替换指定行</span></span><br></pre></td></tr></table></figure>
<h6 id="template模块"><a href="#template模块" class="headerlink" title="template模块"></a>template模块</h6><p>主要用于主控端使用模板配置被控端配置文件的场景</p>
<p>需要用到模板文件，文件必须以.j2结尾</p>
<p>以web应用apache为例</p>
<p>主控端和被控端都通过yum模块按照了httpd，在主控端更改配置文件，并重命名.j2结尾</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible webserver -m template -a <span class="string">&#x27;src=.j2文件路径 dest=被控端主配置文件路径&#x27;</span></span><br><span class="line">如：</span><br><span class="line">ansible webserver -m template -a <span class="string">&#x27;src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf&#x27;</span></span><br></pre></td></tr></table></figure>
<p>也可以在主控端配置文件中引用变量，在主机清单文件中修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/ansible/hosts</span></span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.5 http_port=88</span><br><span class="line">192.168.1.6 http_port=90</span><br></pre></td></tr></table></figure>
<p>修改.j2文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim httpd.conf.j2 </span></span><br><span class="line"> &#123;&#123;http_port&#125;&#125; 引用变量</span><br><span class="line">ServerName www.example.com &#123;&#123;http_port&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>将.j2文件传送</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible webserver -m template -a <span class="string">&#x27;src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这个时候查看被控端的配置文件中，发现1.5的端口为88,16的端口为90</p>
<h6 id="unarchive模块"><a href="#unarchive模块" class="headerlink" title="unarchive模块"></a>unarchive模块</h6><p>将主控端的压缩文件，解压后放在被控端</p>
<p>在主控端有一个nginx安装包，执行以下操作直接解压到被控端</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m unarchive -a <span class="string">&#x27;src=主控端安装包路径 dest=解压后的被控端存放路径&#x27;</span></span><br></pre></td></tr></table></figure>
<h6 id="lineinfile模块"><a href="#lineinfile模块" class="headerlink" title="lineinfile模块"></a>lineinfile模块</h6><p>修改配置文件时，修改指定行的内容，或者添加到指定行前和指定行后</p>
<p>可以实现在文件加入内容</p>
<p>命令参数说明：</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">path</td>
<td align="center">指定要操作的文件对象</td>
</tr>
<tr>
<td align="center">egexp</td>
<td align="center">匹配条件</td>
</tr>
<tr>
<td align="center">insertbefore</td>
<td align="center">在指定行前插入</td>
</tr>
<tr>
<td align="center">insertafter</td>
<td align="center">在指定行后插入</td>
</tr>
<tr>
<td align="center">line</td>
<td align="center">要写入的文件内容</td>
</tr>
<tr>
<td align="center">state</td>
<td align="center">present（添加）absent（删除）</td>
</tr>
</tbody></table>
<p>insertbefore和insertafter的特殊值</p>
<p>BOF：begin of file（文件起始位置）<br>EOF：end of file （文件结束位置）</p>
<p>使用insertbefore和insertafter，还有regexp时，需要指定state，其他不需要</p>
<p>在文件开头插入内容 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m lineinfile -a <span class="string">&#x27;path=文件路径 insertbefore=BOF line=&quot;插入的内容&quot;&#x27;</span></span><br><span class="line">如：</span><br><span class="line">ansible dbserver -m lineinfile -a <span class="string">&#x27;path=/root/nginx.conf insertbefore=BOF line=&quot;# nihao a&quot;&#x27;</span></span><br><span class="line"> 在nginx.conf文件开头添<span class="string">&quot;# nihao a&quot;</span></span><br></pre></td></tr></table></figure>
<p>在文件结束插入内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m lineinfile -a <span class="string">&#x27;path=文件路径 insertbefore=EOF line=&quot;插入的内容&quot;&#x27;</span></span><br><span class="line">如：</span><br><span class="line">ansible dbserver -m lineinfile -a <span class="string">&#x27;path=/root/nginx.conf insertbefore=EOF line=&quot;# nihao a&quot;&#x27;</span></span><br><span class="line"> 在nginx.conf文件的末尾添加<span class="comment"># nihao a</span></span><br></pre></td></tr></table></figure>
<p>在文件指定位置加入内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m lineinfile -a <span class="string">&#x27;path=文件路径 insertbefore=&quot;指定位置的内容&quot; line=&quot;插入的内容&quot; state=present</span></span><br><span class="line"><span class="string">如：</span></span><br><span class="line"><span class="string">ansible dbserver -m lineinfile -a &#x27;</span>path=/root/nginx.conf insertbefore=<span class="string">&quot;  server &#123;&quot;</span> line=<span class="string">&quot;root html&quot;</span> state=present<span class="string">&#x27;</span></span><br><span class="line"><span class="string"> 在nginx.conf的server &#123;的上一行添加root html</span></span><br></pre></td></tr></table></figure>
<p>删除文件中的指定内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 操作对象 -m lineinfile -a <span class="string">&#x27;path=文件路径 regexp=&quot;要删除的内容&quot; line=&quot;插入的内容&quot; state=absent</span></span><br><span class="line"><span class="string">如：</span></span><br><span class="line"><span class="string">ansible dbserver -m lineinfile -a &#x27;</span>path=/root/nginx.conf regexp=<span class="string">&quot; server &#123;&quot;</span> state=absent<span class="string">&#x27;</span></span><br><span class="line"><span class="string"> 删除nginx.conf的server &#123; 这一行</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/18/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/18/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">Ansible自动化运维工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-18 17:16:00 / 修改时间：17:32:10" itemprop="dateCreated datePublished" datetime="2020-09-18T17:16:00+08:00">2020-09-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index"><span itemprop="name">Ansible</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <p><img src="/images/timg.jpg" alt="upload successful"></p>
<h5 id="Ansible及自动化介绍"><a href="#Ansible及自动化介绍" class="headerlink" title="Ansible及自动化介绍"></a>Ansible及自动化介绍</h5><p>ansible：提高效率的工具，实现自动化运维</p>
<p>自动化：系统自动化（PXE+KS/PXE+COBBLER)<br>程序自动化（Ansible/Saltstack/Puppet）<br>代码自动化（Jenkins）</p>
<p>程序自动化工具分为两类：</p>
<p>（1）C/S架构：Saltstack /Puppet</p>
<p>（2）无客户端模式：Ansible（主控端/被控端）</p>
<p>区别：</p>
<p>Ansible：基于python开发，使用ssh协议，没有客户端，200-300台，适用于中小型应用环境，一个系统控制多台主机，有两个角色：主控端和被控端</p>
<p>Saltstack ：基于python开发，支持统一管理，比较轻量级 支持管理500台服务器，python编写，需要部署agent，主控端通过安装在被控端的代理来对被控端进行操作</p>
<p>Puppet：Ruby语言编写，重型程序，适合大型环境，谷歌公司在用，软件过于复杂，国内一般不到1000+</p>
<h5 id="Ansible特性"><a href="#Ansible特性" class="headerlink" title="Ansible特性"></a>Ansible特性</h5><ul>
<li>模块化：调用特定的模块，完成特定的任务，约3000模块，每个模块功能不同</li>
<li>有paramiko（基于ssh开发，主要做远程控制）PyYAML（可以实现剧本）Jinja2（模板语言），这三个模块是Ansible的核心</li>
<li>支持自定义模块（python）</li>
<li>安全，基于openssh</li>
<li>支持playbook编排任务（PyYAML)</li>
<li>幂等性：一个任务执行一遍和n变效果一样，不会因为重复执行而带来意外情况（如：复制文件时，执行两次会报是否覆盖，而使用Ansible可以避免这种情况，后面copy模块会讲到）</li>
</ul>
<h5 id="部署Ansible环境"><a href="#部署Ansible环境" class="headerlink" title="部署Ansible环境"></a>部署Ansible环境</h5><hr>
<p>实验环境：四台linux服务器</p>
<ul>
<li><p>192.168.1.1（用作Ansible服务器）</p>
</li>
<li><p>192.168.1.4（被控端）</p>
</li>
<li><p>192.168.1.5（被控端）</p>
</li>
<li><p>192.168.1.6（被控端）</p>
</li>
</ul>
<p>实验目的：使用控制端来控制3个被控端工作</p>
<p>实验步骤：<br>控制端部署<br>在控制端（192.168.1.1）安装epel-release和Ansible（使用网络yum）</p>
<p>epel-release：Extra Packages for Enterprise Linux（企业版linux扩展包）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建yum缓存，加快yum安装速度</span><br><span class="line">[root@localhost ~]# yum makecache fast</span><br><span class="line">epel是一个系统扩展yum源</span><br><span class="line">[root@localhost ~]# yum -y install epel-release</span><br><span class="line">[root@localhost ~]# yum -y install ansible</span><br></pre></td></tr></table></figure>
<h5 id="设置控制端免密登录被控端"><a href="#设置控制端免密登录被控端" class="headerlink" title="设置控制端免密登录被控端"></a>设置控制端免密登录被控端</h5><p>通过ssh密钥对实现</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ssh-keygen				# 生成私钥和公钥，一直回车即可</span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa key pair.</span><br><span class="line"><span class="function">Enter file in which to save the <span class="title">key</span> <span class="params">(/root/.ssh/id_rsa)</span>: </span></span><br><span class="line"><span class="function">Created directory &#x27;/root/.ssh&#x27;.</span></span><br><span class="line"><span class="function">Enter <span class="title">passphrase</span> <span class="params">(empty <span class="keyword">for</span> no passphrase)</span>: </span></span><br><span class="line"><span class="function">Enter same passphrase again: </span></span><br><span class="line"><span class="function">Your identification has been saved in /root/.ssh/id_rsa.</span></span><br><span class="line"><span class="function">Your <span class="keyword">public</span> key has been saved in /root/.ssh/id_rsa.pub.</span></span><br><span class="line"><span class="function">The key fingerprint is:</span></span><br><span class="line"><span class="function">SHA256:2puXlUxjnsxKrVhnGbNahVhbZLJrMr9q/8B9uDr144Y root</span></span><br><span class="line"><span class="function">The key&#x27;s randomart image is:</span></span><br><span class="line"><span class="function">+---[RSA 2048]----+</span></span><br><span class="line"><span class="function">|            ..o  |</span></span><br><span class="line"><span class="function">|            .+.  |</span></span><br><span class="line"><span class="function">|           o.+   |</span></span><br><span class="line"><span class="function">|          . O..  |</span></span><br><span class="line"><span class="function">|        S oOoX   |</span></span><br><span class="line"><span class="function">|       o  o*/... |</span></span><br><span class="line"><span class="function">|      . .+ X+.+..|</span></span><br><span class="line"><span class="function">|        .oB .E </span>=.|</span><br><span class="line">|        oo.o++=..|</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"> </span><br><span class="line"># 默认生成在当前用户的.ssh/目录下</span><br><span class="line">[root@localhost ~]# ls /root/.ssh</span><br><span class="line">id_rsa  id_rsa.pub</span><br><span class="line"> </span><br><span class="line"># 将生成的公钥文件发送到指定的控制端，需要用到root密码</span><br><span class="line">[root@localhost ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.4</span><br><span class="line">[root@localhost ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.5</span><br><span class="line">[root@localhost ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub root@192.168.1.6</span><br><span class="line"># 此时在1.4的被控端的用户目录下的.ssh目录下会生成一个authorized_keys文件</span><br><span class="line">[root@localhost ~]# ls /root/.ssh</span><br><span class="line">authorized_keys</span><br><span class="line"># 在控制端使用ssh登录到1.4，发现不使用密码即可</span><br><span class="line">[root@localhost ~]# ssh root@192.168.1.4</span><br></pre></td></tr></table></figure>
<h5 id="配置Ansible的配置文件"><a href="#配置Ansible的配置文件" class="headerlink" title="配置Ansible的配置文件"></a>配置Ansible的配置文件</h5><p>ansible.cfg Ansible主配置文件</p>
<p>hosts 被控端的主机清单</p>
<p>roles 角色</p>
<p>修改主机清单：将被控端写入</p>
<p>在使用ansible操作时，可以通过分组名对，组中所有主机进行相同操作</p>
<p>格式为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[分组名]</span><br><span class="line">被控端ip1</span><br><span class="line">被控端ip2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在文件末尾添加，如果有DNS，直接写域名也可以</span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">添加：</span><br><span class="line">[dbserver]</span><br><span class="line">192.168.1.4			<span class="comment"># 被控端</span></span><br><span class="line"> </span><br><span class="line">[webserver]</span><br><span class="line">192.168.1.5			<span class="comment"># 被控端</span></span><br><span class="line">192.168.1.6			<span class="comment"># 被控端</span></span><br></pre></td></tr></table></figure>
<h5 id="Ansible简单操作"><a href="#Ansible简单操作" class="headerlink" title="Ansible简单操作"></a>Ansible简单操作</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible --version			<span class="comment"># 查看ansible版本</span></span><br><span class="line">ansible-doc -l		<span class="comment"># 查看ansible支持模块</span></span><br><span class="line">ansible-doc -s 模块名		<span class="comment"># 关于模块的帮助信息</span></span><br><span class="line">如：ansible-doc -s ping</span><br><span class="line">ansible-doc -h   	<span class="comment"># 帮助信息</span></span><br><span class="line"> </span><br><span class="line">-------关于模块操作的语法-------</span><br><span class="line">ansible 操作对象 -m 模块名 -a <span class="string">&#x27;模块参数&#x27;</span></span><br><span class="line">	-a：在某些模块中可以省略</span><br><span class="line">ansible 操作对象 -m 模块名 -a <span class="string">&#x27;模块参数&#x27;</span> --<span class="built_in">limit</span> x.x.x.x</span><br><span class="line">    --<span class="built_in">limit</span>：可以指定操作对象中的某个ip来执行该模块</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/18/%E5%BC%BA%E5%88%B6%E4%BF%AE%E6%94%B9Linux%E7%B3%BB%E7%BB%9F%E7%9A%84Root%E5%AF%86%E7%A0%81%E7%9A%84%E5%8A%9E%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/18/%E5%BC%BA%E5%88%B6%E4%BF%AE%E6%94%B9Linux%E7%B3%BB%E7%BB%9F%E7%9A%84Root%E5%AF%86%E7%A0%81%E7%9A%84%E5%8A%9E%E6%B3%95/" class="post-title-link" itemprop="url">强制修改Linux系统的Root密码的办法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-18 16:17:00 / 修改时间：20:45:46" itemprop="dateCreated datePublished" datetime="2020-09-18T16:17:00+08:00">2020-09-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <h5 id="1-在Linux-的引导界面按-E-键来进入内核编辑界面"><a href="#1-在Linux-的引导界面按-E-键来进入内核编辑界面" class="headerlink" title="1.在Linux 的引导界面按 E 键来进入内核编辑界面"></a>1.在Linux 的引导界面按 E 键来进入内核编辑界面</h5><p><img src="/images/test0.png" alt="upload successful"></p>
<h5 id="2-按键盘下键，找到Linux16这一行，然后在最后边加入-rd-break命令，然后按Ctrl-X来重启修改过的内核"><a href="#2-按键盘下键，找到Linux16这一行，然后在最后边加入-rd-break命令，然后按Ctrl-X来重启修改过的内核" class="headerlink" title="2.按键盘下键，找到Linux16这一行，然后在最后边加入 rd.break命令，然后按Ctrl+X来重启修改过的内核!"></a>2.按键盘下键，找到Linux16这一行，然后在最后边加入 rd.break命令，然后按Ctrl+X来重启修改过的内核!</h5><p><img src="/images/test1.png" alt="upload successful"></p>
<h5 id="3-之后进入“紧急求援模式”"><a href="#3-之后进入“紧急求援模式”" class="headerlink" title="3. 之后进入“紧急求援模式”"></a>3. 之后进入“紧急求援模式”</h5><p>   输入以下命令（输入完一行回车！）</p>
<p>   mount -o remount,rw /sysroot</p>
<p>   chroot /sysroot</p>
<p>   passwd    # 当输入完这一行会系统会让你输入新密码和确认新密码，按照系统提示输入即可！</p>
<p>   touch /.autorelabel</p>
<p>   exit</p>
<p>   reboot<br><img src="/images/test2.png" alt="upload successful"></p>
<h5 id="4-接着等待重启以后就可以使用root账号了"><a href="#4-接着等待重启以后就可以使用root账号了" class="headerlink" title="4.接着等待重启以后就可以使用root账号了"></a>4.接着等待重启以后就可以使用root账号了</h5>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/11/%E5%8D%87%E7%BA%A7Openssh%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/11/%E5%8D%87%E7%BA%A7Openssh%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/" class="post-title-link" itemprop="url">升级Openssh详细步骤</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-11 15:34:00" itemprop="dateCreated datePublished" datetime="2020-09-11T15:34:00+08:00">2020-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-13 09:45:22" itemprop="dateModified" datetime="2020-09-13T09:45:22+08:00">2020-09-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <h4 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h4><p>1.1、下载相关软件包</p>
<blockquote>
<p>OpenSSH需要依赖ZLIB和OpenSSL，因此需要从官网下载三者的源码包。需要注意的是：OpenSSH最新版8.1p1依赖的OpenSSL版本为1.0.2k，而不是其最新版1.1.0e（使用此版会升级失败）,ZLIB可以使用最新 版1.2.11。 </p>
</blockquote>
<p>三者源码下载地址：</p>
<pre><code> http://www.zlib.net/
 http://www.openssl.org/
 http://www.openssh.org/</code></pre>
<p>1.2、查看系统当前软件版本</p>
<pre><code># rpm -q zlib
# openssl version
# ssh -V</code></pre>
<p>1.3、配置在线yum源</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd <span class="regexp">/etc/yum</span>.repos.d</span><br><span class="line"># rm -rf *             #删除当前所有yum源文件</span><br><span class="line"></span><br><span class="line"># wget -O <span class="regexp">/etc/yum</span>.repos.d<span class="regexp">/CentOS-Base.repo http:/</span><span class="regexp">/mirrors.aliyun.com/</span>repo/Centos-<span class="number">6</span>.repo   #连接阿里云在线源</span><br></pre></td></tr></table></figure>

<p>1.4、安装telnet服务并启用</p>
<blockquote>
<p>因升级OpenSSH过程中需要卸载现有OpenSSH, 因此为了保持服务器的远程连接可用，需要启用telnet服务作为替代，如升级出现问题，也可通过telnet登录服务器进行回退。</p>
</blockquote>
<p>   A、安装telnet服务</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum -y install telnet-server*</span></span><br></pre></td></tr></table></figure>
<p>   B、启用telnet</p>
<p>   先关闭防火墙，否则telnet可能无法连接</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># service iptables stop</span></span><br><span class="line"><span class="meta"># chkconfig iptables off</span></span><br><span class="line"><span class="meta"># vi /etc/xinetd.d/telnet</span></span><br><span class="line">将其中disable字段的yes改为no以启用telnet服务</span><br><span class="line"><span class="meta"># mv /etc/securetty /etc/securetty.old          #允许root用户通过telnet登录</span></span><br><span class="line"><span class="meta"># /etc/init.d/xinetd start       #启动telnet服务</span></span><br><span class="line"><span class="meta"># chkconfig xinetd on              #使telnet服务开机启动，避免升级过程中服务器意外重启后无法远程登录系统</span></span><br><span class="line"><span class="meta"># telnet [ip]                 #新开启一个远程终端以telnet登录验证是否成功启用</span></span><br></pre></td></tr></table></figure>
<p>1.5、安装编译所需工具包</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum -y install gcc pam-devel zlib-devel</span></span><br></pre></td></tr></table></figure>

<h4 id="2、正式升级"><a href="#2、正式升级" class="headerlink" title="2、正式升级"></a>2、正式升级</h4><p>2.1、升级ZLIB</p>
<p>A、解压zlib_1.2.11源码并编译</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># tar -zxvf zlib-1.2.11.tar.gz</span></span><br><span class="line"><span class="meta"># cd zlib-1.2.11</span></span><br><span class="line"><span class="meta"># ./configure --prefix=/usr</span></span><br><span class="line"><span class="meta"># make</span></span><br></pre></td></tr></table></figure>
<p>B、卸载当前zlib</p>
<blockquote>
<p>注意：此步骤必须在步骤A执行完毕后再执行，否则先卸载zlib后，/lib64/目录下的zlib相关库文件会被删除，步骤A编译zlib会失败。</p>
</blockquote>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># rpm -e --nodeps zlib </span></span><br></pre></td></tr></table></figure>

<p>C、安装之前编译好的zlib </p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># make install </span></span><br></pre></td></tr></table></figure>
<p>在zlib编译目录执行如下命令</p>
<p>D、共享库注册</p>
<blockquote>
<p>zlib安装完成后，会在/usr/lib目录中生产zlib相关库文件，需要将这些共享库文件注册到系统中。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;/usr/lib&#x27;</span> &gt;&gt; /etc/ld.so.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ldconfig <span class="comment">#更新共享库cache</span></span></span><br></pre></td></tr></table></figure>

<p>2.2、升级OpenSSL</p>
<p>A、备份当前openssl</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">find</span> / -name openssl</span><br><span class="line">  <span class="regexp">/usr/</span>lib64/openssl</span><br><span class="line">  <span class="regexp">/usr/</span>bin/openssl</span><br><span class="line">  <span class="regexp">/etc/</span>pki<span class="regexp">/ca-trust/</span>extracted/openssl</span><br><span class="line"></span><br><span class="line"># mv <span class="regexp">/usr/</span>lib64<span class="regexp">/openssl /u</span>sr<span class="regexp">/lib64/</span>openssl.old</span><br><span class="line"># mv <span class="regexp">/usr/</span>bin<span class="regexp">/openssl /u</span>sr<span class="regexp">/bin/</span>openssl.old</span><br><span class="line"># mv <span class="regexp">/etc/</span>pki<span class="regexp">/ca-trust/</span>extracted<span class="regexp">/openssl /</span>etc<span class="regexp">/pki/</span>ca-trust<span class="regexp">/extracted/</span>openssl.old</span><br><span class="line"></span><br><span class="line">如下两个库文件必须先备份，因系统内部分工具（如yum、wget等）依赖此库，而新版OpenSSL不包含这两个库</span><br><span class="line"># cp <span class="regexp">/usr/</span>lib64<span class="regexp">/libcrypto.so.10 /u</span>sr<span class="regexp">/lib64/</span>libcrypto.so.<span class="number">10</span>.old</span><br><span class="line"># cp <span class="regexp">/usr/</span>lib64<span class="regexp">/libssl.so.10 /u</span>sr<span class="regexp">/lib64/</span>libssl.so.<span class="number">10</span>.old</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>B、卸载当前openssl</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -qa | grep openssl</span></span><br><span class="line">   <span class="attribute">openssl</span>-<span class="number">1</span>.<span class="number">0</span>.<span class="number">1</span>e-<span class="number">42</span>.el<span class="number">6</span>.x<span class="number">86</span>_<span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -e --nodeps openssl-1.0.1e-42.el6.x86_64</span></span><br><span class="line"><span class="comment"># rpm -qa | grep openssl</span></span><br></pre></td></tr></table></figure>

<p>C、解压openssl_1.0.2k源码并编译安装</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># tar -zxvf openssl-1.0.2k.tar.gz</span></span><br><span class="line"><span class="meta"># cd openssl-1.0.2k</span></span><br><span class="line"><span class="meta"># ./config --prefix=/usr --openssldir=/etc/ssl --shared zlib                                #必须加上--shared，否则编译时会找不到新安装的openssl的库而报错</span></span><br><span class="line"><span class="meta"># make</span></span><br><span class="line"><span class="meta"># make test                             #必须执行这一步结果为pass才能继续，否则即使安装完成，ssh也无法使用</span></span><br><span class="line"><span class="meta"># make install</span></span><br><span class="line"><span class="meta"># openssl version -a                           #查看是否升级成功</span></span><br></pre></td></tr></table></figure>

<p>D、恢复共享库</p>
<blockquote>
<p>由于OpenSSL_1.0.2k不提供libcrypto.so.10和libssl.so.10这两个库，而yum、wget等工具又依赖此库，因此需要将先前备份的这两个库进行恢复，其他的可视情况考虑是否恢复。</p>
</blockquote>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mv <span class="regexp">/usr/</span>lib64<span class="regexp">/libcrypto.so.10.old  /u</span>sr<span class="regexp">/lib64/</span>libcrypto.so.<span class="number">10</span></span><br><span class="line"># mv <span class="regexp">/usr/</span>lib64<span class="regexp">/libssl.so.10.old   /u</span>sr<span class="regexp">/lib64/</span>libssl.so.</span><br></pre></td></tr></table></figure>

<p>2.3、升级OpenSSH</p>
<p>A、备份当前openssh</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mv <span class="regexp">/etc/</span>ssh  <span class="regexp">/etc/</span>ssh.old</span><br></pre></td></tr></table></figure>

<p>B、卸载当前openssh</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -qa | grep openssh</span></span><br><span class="line"><span class="attribute">openssh</span>-clients-<span class="number">5</span>.<span class="number">3</span>p<span class="number">1</span>-<span class="number">111</span>.el<span class="number">6</span>.x<span class="number">86</span>_<span class="number">64</span></span><br><span class="line"><span class="attribute">openssh</span>-server-<span class="number">5</span>.<span class="number">3</span>p<span class="number">1</span>-<span class="number">111</span>.el<span class="number">6</span>.x<span class="number">86</span>_<span class="number">64</span></span><br><span class="line"><span class="attribute">openssh</span>-<span class="number">5</span>.<span class="number">3</span>p<span class="number">1</span>-<span class="number">111</span>.el<span class="number">6</span>.x<span class="number">86</span>_<span class="number">64</span></span><br><span class="line"><span class="attribute">openssh</span>-askpass-<span class="number">5</span>.<span class="number">3</span>p<span class="number">1</span>-<span class="number">111</span>.el<span class="number">6</span>.x<span class="number">86</span>_<span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -e --nodeps openssh-5.3p1-111.el6.x86_64</span></span><br><span class="line"><span class="comment"># rpm -e --nodeps openssh-server-5.3p1-111.el6.x86_64</span></span><br><span class="line"><span class="comment"># rpm -e --nodeps openssh-clients-5.3p1-111.el6.x86_64</span></span><br><span class="line"><span class="comment"># rpm -e --nodeps openssh-askpass-5.3p1-111.el6.x86_64</span></span><br><span class="line"><span class="comment"># rpm -qa | grep openssh                # 查看是否卸载成功</span></span><br></pre></td></tr></table></figure>

<p>C、openssh安装前环境配置</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># install -v -m700 -d <span class="regexp">/var/</span>lib/sshd</span><br><span class="line"># chown -v root:sys <span class="regexp">/var/</span>lib/sshd</span><br><span class="line"># groupadd -g <span class="number">50</span> sshd</span><br><span class="line"># useradd -c <span class="string">&#x27;sshd PrivSep&#x27;</span> -d <span class="regexp">/var/</span>lib<span class="regexp">/sshd -g sshd -s /</span>bin/<span class="keyword">false</span> -u <span class="number">50</span> sshd</span><br></pre></td></tr></table></figure>

<p>D、解压openssh_7.4p1源码并编译安装</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf openssh<span class="number">-8.1</span>p1.tar.gz</span><br><span class="line"># cd openssh<span class="number">-8.1</span>p1</span><br><span class="line"># ./configure --prefix=/usr --sysconfdir=/etc/ssh --<span class="keyword">with</span>-md5-passwords --<span class="keyword">with</span>-pam --<span class="keyword">with</span>-zlib --<span class="keyword">with</span>-openssl-includes=/usr --<span class="keyword">with</span>-privsep-path=/var/lib/sshd</span><br><span class="line"># make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>

<p>E、openssh安装后环境配置</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 在openssh编译目录执行如下命令</span><br><span class="line"># install -v -m755 contrib<span class="regexp">/ssh-copy-id /u</span>sr/bin</span><br><span class="line"># install -v -m644 contrib<span class="regexp">/ssh-copy-id.1 /u</span>sr<span class="regexp">/share/m</span>an/man1</span><br><span class="line"># install -v -m755 -d <span class="regexp">/usr/</span>share<span class="regexp">/doc/</span>openssh-<span class="number">8.1</span>p1</span><br><span class="line"># install -v -m644 INSTALL LICENCE OVERVIEW README* <span class="regexp">/usr/</span>share<span class="regexp">/doc/</span>openssh-<span class="number">8.1</span>p1</span><br><span class="line"># ssh -V #验证是否升级成功</span><br></pre></td></tr></table></figure>

<p>F、启用OpenSSH服务</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 在openssh编译目录执行如下目录</span></span><br><span class="line"><span class="meta"># echo &#x27;X11Forwarding yes&#x27; &gt;&gt; /etc/ssh/sshd_config</span></span><br><span class="line"><span class="meta"># echo &quot;PermitRootLogin yes&quot; &gt;&gt; /etc/ssh/sshd_config #允许root用户通过ssh登录</span></span><br><span class="line"><span class="meta"># cp -p contrib/redhat/sshd.init /etc/init.d/sshd</span></span><br><span class="line"><span class="meta"># chmod +x /etc/init.d/sshd</span></span><br><span class="line"><span class="meta"># chkconfig --add sshd</span></span><br><span class="line"><span class="meta"># chkconfig sshd on</span></span><br><span class="line"><span class="meta"># chkconfig --list sshd</span></span><br><span class="line"><span class="meta"># /etc/init.d/sshd restart</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果升级操作一直是在ssh远程会话中进行的，上述sshd服务重启命令可能导致会话断开并无法使用ssh再行登入（即ssh未能成功重启），此时需要通过telnet登入再执行sshd服务重启命令。</p>
</blockquote>
<h4 id="3、善后工作"><a href="#3、善后工作" class="headerlink" title="3、善后工作"></a>3、善后工作</h4><blockquote>
<p>新开启远程终端以ssh [ip]登录系统，确认一切正常升级成功后，只需关闭telnet服务以保证系统安全性即可。</p>
</blockquote>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mv <span class="regexp">/etc/</span>securetty.old  <span class="regexp">/etc/</span>securetty</span><br><span class="line"># chkconfig xinetd off</span><br><span class="line"># <span class="regexp">/etc/i</span>nit.d/xinetd stop</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/11/%E6%9C%AC%E5%9C%B0MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91RDS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/11/%E6%9C%AC%E5%9C%B0MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91RDS/" class="post-title-link" itemprop="url">本地MySQL数据库迁移到阿里云RDS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-11 15:29:00 / 修改时间：15:33:24" itemprop="dateCreated datePublished" datetime="2020-09-11T15:29:00+08:00">2020-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <h5 id="连接本地数据库"><a href="#连接本地数据库" class="headerlink" title="连接本地数据库"></a>连接本地数据库</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h localhost -u root -p</span><br></pre></td></tr></table></figure>

<h5 id="创建账号"><a href="#创建账号" class="headerlink" title="创建账号"></a>创建账号</h5><blockquote>
<p>首先要在本地创建一个用来迁移的帐号，并给这个帐号设置权限。</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>sername：待创建的账号。<br>host：允许该账号登录的主机，如果允许该账号从任意主机登录数据库，可以使用百分号（%）<br>password：账号的密码。 </p>
</blockquote>
<p>EG：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如，创建一个账号，账号名为dtsmigration</span></span><br><span class="line"><span class="comment"># 密码为Dts123456，并允许从任意主机登录数据库，命令如下。</span></span><br><span class="line">CREATE USER <span class="string">&#x27;dtsmigration&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;Dts123456&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT privileges ON databasename.tablename TO <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;host&#x27;</span> WITH GRANT OPTION;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>privileges：授予该账号的操作权限，如SELECT、INSERT、UPDATE等，如果要授予该账号所有权限则使用ALL。<br>databasename：数据库名。如果要授予该账号具备所有数据库的操作权限，则使用星号（）。<br>tablename：表名。如果要授予该账号具备所有表的操作权限，则使用星号（）。<br>username：待授权的账号。<br>host：允许该账号登录的主机，如果允许该账号从任意主机登录，则使用百分号（%）。<br>WITH GRANT OPTION：授予该账号使用GRANT命令的权限，该参数为可选。</p>
</blockquote>
<p>EG:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 授予dtsmigration账号具备所有数据库和表的所有权限</span></span><br><span class="line"><span class="comment"># 并允许从任意主机登录数据库，命令如下。</span></span><br><span class="line">GRANT ALL ON *.* TO <span class="string">&#x27;dtsmigration&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="本地数据库状态"><a href="#本地数据库状态" class="headerlink" title="本地数据库状态"></a>本地数据库状态</h3><h5 id="1-确认源库的binlog是否开启"><a href="#1-确认源库的binlog是否开启" class="headerlink" title="1.确认源库的binlog是否开启"></a>1.确认源库的binlog是否开启</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global variables like <span class="string">&quot;log_bin&quot;</span>;</span><br></pre></td></tr></table></figure>
<h6 id="不是的话配置一下my-cnf"><a href="#不是的话配置一下my-cnf" class="headerlink" title="不是的话配置一下my.cnf"></a>不是的话配置一下my.cnf</h6><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_bin=mysql_bin</span><br><span class="line">binlog_format=row</span><br><span class="line">server_id=<span class="number">2</span> /<span class="regexp">/设置大于1的整数</span></span><br><span class="line"><span class="regexp">binlog_row_image=full     **/</span><span class="regexp">/当自建MySQL的版本大于5.6时，则必须设置该项**</span></span><br></pre></td></tr></table></figure>
<h6 id="修改之后重启MySQL"><a href="#修改之后重启MySQL" class="headerlink" title="修改之后重启MySQL"></a>修改之后重启MySQL</h6><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysql</span><br></pre></td></tr></table></figure>
<h5 id="2-确认源库的binlog格式为row模式"><a href="#2-确认源库的binlog格式为row模式" class="headerlink" title="2.确认源库的binlog格式为row模式"></a>2.确认源库的binlog格式为row模式</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global variables like <span class="string">&quot;binlog_format&quot;</span>;</span><br></pre></td></tr></table></figure>
<h6 id="不是的话配置一下"><a href="#不是的话配置一下" class="headerlink" title="不是的话配置一下"></a>不是的话配置一下</h6><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global binlog_format=ROW;</span><br></pre></td></tr></table></figure>
<h5 id="3-当地mysql版本大等于5-6-2时，确认源库的binlog-row-image-full"><a href="#3-当地mysql版本大等于5-6-2时，确认源库的binlog-row-image-full" class="headerlink" title="3.当地mysql版本大等于5.6.2时，确认源库的binlog_row_image=full"></a>3.当地mysql版本大等于5.6.2时，确认源库的binlog_row_image=full</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global variables like <span class="string">&quot;binlog_row_image&quot;</span>;</span><br></pre></td></tr></table></figure>
<h6 id="不是的话配置一下-1"><a href="#不是的话配置一下-1" class="headerlink" title="不是的话配置一下"></a>不是的话配置一下</h6><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global binlog_row_image=full;</span><br></pre></td></tr></table></figure>
<h5 id="进行迁移"><a href="#进行迁移" class="headerlink" title="进行迁移"></a>进行迁移</h5><blockquote>
<p>阿里云官方文档<br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/126875.html?spm=a2c4g.11186623.2.10.14554b43IHTNie">https://help.aliyun.com/document_detail/126875.html?spm=a2c4g.11186623.2.10.14554b43IHTNie</a><br>需要先设置一下网关<br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/159587.html?spm=5176.10695662.1996646101.searchclickresult.1de2d223X9cjTe">https://help.aliyun.com/document_detail/159587.html?spm=5176.10695662.1996646101.searchclickresult.1de2d223X9cjTe</a><br>注意设置好网关之后要使用无公网:Port的数据库（通过数据库网关DG接入）</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/10/Docker%E9%83%A8%E7%BD%B2nginx%E5%8F%8Aweb%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/10/Docker%E9%83%A8%E7%BD%B2nginx%E5%8F%8Aweb%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">Docker部署nginx及web集群</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-10 17:42:00 / 修改时间：17:47:12" itemprop="dateCreated datePublished" datetime="2020-09-10T17:42:00+08:00">2020-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <p>在容器部署基于centos镜像的nginx：</p>
<p>首先将nginx软件包放入物理机（虚拟机）中</p>
<p>进去容器后，什么都没有，环境相当干净，所以各种命令需要自己安装</p>
<p>使用yum provides 查看命令的软件包，并且进行安装，即可使用</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum provides ip<span class="regexp">/ifconfig/</span>scp</span><br><span class="line">yum -y install iproute   <span class="regexp">//i</span>p</span><br><span class="line">yum -y install net-tools <span class="regexp">//i</span>fconfig</span><br><span class="line">yum -y install openssh-clients  <span class="regexp">//</span>scp</span><br></pre></td></tr></table></figure>
<p>准备nginx环境</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">yum</span> <span class="literal">-</span><span class="comment">y</span> <span class="comment">install</span> <span class="comment">gcc</span> <span class="comment">gcc</span><span class="literal">-</span><span class="comment">c</span>++ <span class="comment">pcre</span><span class="literal">-</span><span class="comment">devel</span> <span class="comment">zlib</span><span class="literal">-</span><span class="comment">devel</span> <span class="comment">openssl</span><span class="literal">-</span><span class="comment">devel</span> <span class="comment">make</span></span><br></pre></td></tr></table></figure>
<p>查看容器的IP地址</p>
<p><img src="/images/pasted-20.png" alt="upload successful"></p>
<p>退出容器：exit</p>
<p>查看本地ip，docker网卡</p>
<p><img src="/images/pasted-21.png" alt="upload successful"></p>
<p>方法一：在容器中，将物理机的软件包拷贝到容器中</p>
<p><img src="/images/pasted-22.png" alt="upload successful"></p>
<p>方法二：在物理机中，3a9f…0c4为容器的id，也可以使用容器名（–name指定的名称）</p>
<p><img src="/images/pasted-23.png" alt="upload successful"></p>
<h6 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h6><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar zxf nginx-<span class="number">1.12</span>.<span class="number">0</span>.tar.gz -C <span class="regexp">/usr/</span>src</span><br><span class="line">cd <span class="regexp">/usr/</span>src<span class="regexp">/nginx-1.12.0/</span></span><br><span class="line">.<span class="regexp">/configure --prefix=/u</span>sr<span class="regexp">/local/</span>nginx --user=nginx --<span class="keyword">group</span>=ngixn --with-http_stub_status_module --with-pcre &amp;&amp; make &amp;&amp; make install</span><br><span class="line">useradd nginx</span><br><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin<span class="regexp">/nginx /u</span>sr<span class="regexp">/local/</span>sbin/nginx</span><br><span class="line">/nginx</span><br></pre></td></tr></table></figure>

<p>修改页面文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;172.17.0.2&quot;</span> &gt; <span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>html/index.html</span><br></pre></td></tr></table></figure>

<p>启动nginx</p>
<p><img src="/images/pasted-24.png" alt="upload successful"></p>
<p>测试</p>
<p><img src="/images/pasted-25.png" alt="upload successful"></p>
<p>为了后面做web集群时方便使用，可以将上面安装好命令与nginx的容器做一个镜像，方便后期使用。</p>
<p>将配置好的容器制作成一个镜像</p>
<p>docker commit 容器id  镜像名称</p>
<p><img src="/images/pasted-26.png" alt="upload successful"></p>
<p>将做好的镜像导出到本地（用于做备份）</p>
<p><img src="/images/pasted-27.png" alt="upload successful"></p>
<p>模拟误删除镜像</p>
<p><img src="/images/pasted-28.png" alt="upload successful"></p>
<p>将已导出的镜像tar包，再导入进来（这时发现删除的镜像又回来了）</p>
<p><img src="/images/pasted-29.png" alt="upload successful"></p>
<p>WEB集群<br>使用zu镜像做一个web2容器</p>
<p><img src="/images/pasted-30.png" alt="upload successful"></p>
<p><img src="/images/pasted-31.png" alt="upload successful"></p>
<p>修改页面文件</p>
<p><img src="/images/pasted-32.png" alt="upload successful"></p>
<p>启动nginx，并退出容器</p>
<p><img src="/images/pasted-33.png" alt="upload successful"></p>
<p>使用zu镜像做一个web3容器</p>
<p><img src="/images/pasted-34.png" alt="upload successful"></p>
<p>修改页面文件</p>
<p><img src="/images/pasted-35.png" alt="upload successful"></p>
<p>启动nginx</p>
<p><img src="/images/pasted-36.png" alt="upload successful"></p>
<p><img src="/images/pasted-37.png" alt="upload successful"></p>
<h6 id="本地部署nginx"><a href="#本地部署nginx" class="headerlink" title="本地部署nginx"></a>本地部署nginx</h6><p>安装环境</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span>  pcre-devel zlib-devel openssl-devel</span><br></pre></td></tr></table></figure>
<p>安装nginx</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar zxf nginx-<span class="number">1.12</span>.<span class="number">0</span>.tar.gz -C <span class="regexp">/usr/</span>src/</span><br><span class="line">cd <span class="regexp">/usr/</span>src<span class="regexp">/nginx-1.12.0/</span></span><br><span class="line">.<span class="regexp">/configure --prefix=/u</span>sr<span class="regexp">/local/</span>nginx --user=nginx --<span class="keyword">group</span>=nginx --with-http_stub_status_module --with-pcre &amp;&amp; make &amp;&amp; make install</span><br><span class="line">useradd nginx</span><br><span class="line">ln -s <span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin<span class="regexp">/nginx /u</span>sr<span class="regexp">/local/</span>sbin/nginx</span><br></pre></td></tr></table></figure>
<p>修改配置文件<br>vim /usr/local/nginx/conf/nginx.conf</p>
<p><img src="/images/pasted-38.png" alt="upload successful"><br>启动nginx</p>
<p><img src="/images/pasted-39.png" alt="upload successful"><br>测试</p>
<p><img src="/images/pasted-40.png" alt="upload successful"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/10/commit%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/10/commit%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F/" class="post-title-link" itemprop="url">commit构建镜像</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-10 17:40:00 / 修改时间：17:41:49" itemprop="dateCreated datePublished" datetime="2020-09-10T17:40:00+08:00">2020-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <h6 id="用docker-commit构建映像"><a href="#用docker-commit构建映像" class="headerlink" title="用docker commit构建映像"></a>用docker commit构建映像</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">　　<span class="number">1</span><span class="selector-class">.docker</span> run -<span class="selector-tag">i</span> -t centos /bin/bash　　<span class="comment">//启动一个容器，启动后默认进入该窗口的bash进程</span></span><br><span class="line">　　<span class="number">2</span><span class="selector-class">.yum</span> install -y epel-release<span class="selector-class">.noarch</span>　　<span class="comment">//为启动的窗口安装软件源</span></span><br><span class="line">　　<span class="number">3</span><span class="selector-class">.yum</span> install -y nginx　　<span class="comment">//为启动的容器安装nginx</span></span><br><span class="line">　　<span class="number">4</span><span class="selector-class">.exit</span>　　<span class="comment">//退出该容器，回到宿主机环境</span></span><br><span class="line">　　<span class="number">5</span><span class="selector-class">.docker</span> commit 容器ID zx/nginx　　<span class="comment">//将上次创建的窗口ID当作映像提交到本地,zrs是repository名称,nginx是image名称</span></span><br><span class="line">　　<span class="number">6</span><span class="selector-class">.docker</span> images　　<span class="comment">//可以查看到上步提交的映像</span></span><br></pre></td></tr></table></figure>
<h6 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h6><p>　　　　1.一定要区分开容器和映像的区别；</p>
<p>　　　　2.有了zx/nginx后，下次可以直接使用该映像来启动容器，而不用为这个容器安装nginx;</p>
<p>　　　　3.docker commit -m=”this is a container contains nginx” –author=”zx” 容器ID zx/nginx，类似git不作多余解释；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/10/Docker%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/10/Docker%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/" class="post-title-link" itemprop="url">Docker私有仓库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-10 17:30:00 / 修改时间：17:39:40" itemprop="dateCreated datePublished" datetime="2020-09-10T17:30:00+08:00">2020-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <h5 id="Docker的公共仓库"><a href="#Docker的公共仓库" class="headerlink" title="Docker的公共仓库"></a><a target="_blank" rel="noopener" href="https://hub.docker.com/">Docker的公共仓库</a></h5><p>由Docker公司维护的Registry，用户也可以将自己的镜像保存到DockerHub上中免费的response中，因为在国内访问由很多的限制<br>登录方法</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u 用户名 密码 https:<span class="regexp">//</span></span><br></pre></td></tr></table></figure>
<p>登录后下载方法</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull 用户名/images名:<span class="keyword">tag</span></span><br></pre></td></tr></table></figure>
<h5 id="Quay"><a href="#Quay" class="headerlink" title="Quay"></a><a target="_blank" rel="noopener" href="https://quay.io/">Quay</a></h5><p>被红帽收购后速度相当慢，红帽对国内还不是完全开放，是一个私人注册托管中心，它上面更多的是很多用户自己上传制作的镜像，没有很多的官方镜像，使用面也不是很广</p>
<h5 id="阿里云镜像仓库"><a href="#阿里云镜像仓库" class="headerlink" title="阿里云镜像仓库"></a>阿里云镜像仓库</h5><p>是国内提供docker镜像的仓库，需要用户登录后在控制中心，找到容器镜像服务，可以镜像镜像搜索、新建自己的仓库、也包括官方镜像和其他用户开放的镜像，官方镜像是直接拿取的DockerHub的镜像，属于国内的一个缓存。</p>
<p>这些公有镜像不适合工作中去使用，接下来就看私有仓库</p>
<h5 id="使用registry私有仓库镜像"><a href="#使用registry私有仓库镜像" class="headerlink" title="使用registry私有仓库镜像"></a>使用registry私有仓库镜像</h5><p>Harbor仓库在微服务架构的文章中已经写到怎么使用了，这里就不多说了</p>
<p>环境要：Docker服务器必须开启路由转发</p>
<p>使用两台主机来完成接下来验证私有仓库的使用</p>
<table>
<thead>
<tr>
<th align="center">主机</th>
<th align="center">服务</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.1.11</td>
<td align="center">已安装启动docker</td>
<td align="center">私有仓库</td>
</tr>
<tr>
<td align="center">192.168.1.12</td>
<td align="center">已安装启动docker</td>
<td align="center"></td>
</tr>
</tbody></table>
<h6 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h6><p>两台主机都做路由转发</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;net.ipv4.ip_forward = 1&quot;</span> &gt;&gt; <span class="regexp">/etc/</span>sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h6 id="下载私库镜像"><a href="#下载私库镜像" class="headerlink" title="下载私库镜像"></a>下载私库镜像</h6><p><code>192.168.1.11</code></p>
<p>下载2版本的私有仓库镜像，2版本是go语言写的，速度和安全性都比1要好，1是python写的</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# docker pull registry:<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>创建私库在本地物理机的存放路径</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># mkdir -p /opt/data/registry</span></span><br></pre></td></tr></table></figure>
<p>运行私库</p>
<p>使用镜像实例化，并进行相应的指定，后台运行仓库</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -p 5000:5000 --restart always \</span><br><span class="line">-<span class="ruby">-volume /opt/data/registry/<span class="symbol">:/var/lib/registry</span> <span class="symbol">registry:</span><span class="number">2</span></span></span><br><span class="line"><span class="ruby"><span class="comment"># 解释参数</span></span></span><br><span class="line"><span class="ruby">-p：指定端口，<span class="number">5000</span><span class="symbol">:</span><span class="number">5000</span>表示在物理机开一个端口，在容器内开一个端口</span></span><br><span class="line"><span class="ruby">--restart always：无论容器遇到什么错误就会重启容器</span></span><br><span class="line"><span class="ruby">-v/--volume：本地目录映射到容器内的目录</span></span><br><span class="line"><span class="ruby"><span class="number">5000</span>：是registry的端口号</span></span><br><span class="line"><span class="ruby">/var/lib/registry：是registry仓库中存放镜像的目录</span></span><br></pre></td></tr></table></figure>
<p>运行起来后，在本地是可以监听到5000端口的</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# netstat -anput | grep <span class="number">5000</span></span><br><span class="line">tcp6     <span class="number">0</span>      <span class="number">0</span> :::<span class="number">5000</span>      :::*         LISTEN      <span class="number">80040</span>/docker-proxy</span><br></pre></td></tr></table></figure>
<p>查看仓库中的镜像</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# curl <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/v2/_catalog</span><br><span class="line">&#123;<span class="string">&quot;repositories&quot;</span>:[]&#125;  # 表示没有任何镜像</span><br></pre></td></tr></table></figure>
<h6 id="指定私库地址"><a href="#指定私库地址" class="headerlink" title="指定私库地址"></a>指定私库地址</h6><p>需要修改docker的服务文件，让docker知道私有仓库地址</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# vim /usr/lib/systemd/system/docker.service </span><br><span class="line"># <span class="number">14</span>行的末尾添加--insecure-registry <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span></span><br><span class="line"># <span class="number">14</span>行也就是以ExecStart开头的一行</span><br></pre></td></tr></table></figure>
<p>重新加载配置文件，并重启服务生效</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># systemctl daemon-reload </span></span><br><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>
<p>查看服务状态，可以看到是否识别到了私有仓库</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span> <span class="string">~</span>]<span class="comment"># systemctl status docker -l</span></span><br><span class="line"><span class="comment"># 找到以下关键信息，则代表识别私库地址成功</span></span><br><span class="line">   <span class="attr">CGroup:</span> <span class="string">/system.slice/docker.service</span></span><br><span class="line">           <span class="string">├─80357</span> <span class="string">/usr/bin/dockerd</span> <span class="string">-H</span> <span class="string">fd://</span> <span class="string">--containerd=/run/containerd/containerd.sock</span> <span class="string">--insecure-registry</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span><span class="string">:5000</span></span><br><span class="line">           <span class="string">└─80477</span> <span class="string">/usr/bin/docker-proxy</span> <span class="string">-proto</span> <span class="string">tcp</span> <span class="string">-host-ip</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="string">-host-port</span> <span class="number">5000</span> <span class="string">-container-ip</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span> <span class="string">-container-port</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<p><code>192.168.1.12</code><br>进行修改docker的文件去指向docker的私有仓库地址</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# vim /usr/lib/systemd/system/docker.service </span><br><span class="line"># <span class="number">14</span>行的末尾添加--insecure-registry <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span></span><br><span class="line"># <span class="number">14</span>行也就是以ExecStart开头的一行</span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# systemctl daemon-reload </span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# systemctl restart docker</span><br></pre></td></tr></table></figure>
<h6 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h6><p><code>192.168.1.11</code><br>使用tag为镜像改个名字<br>注意：改名字要按照格式来私库ip:5000/镜像名，否则会上传失败<br>此时镜像名的作用：push到私库中（私库ip:5000），镜像名为httpd</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# docker tag httpd:latest <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/httpd</span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# docker tag centos:latest <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/centos</span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# docker tag busybox:latest <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/busybox</span><br></pre></td></tr></table></figure>
<p>将改名后的镜像上传到私有仓库中</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# docker push <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/httpd</span><br><span class="line">The push <span class="built_in">ref</span>ers to repository [<span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/httpd]</span><br><span class="line"><span class="number">25</span>a92d79dbfe: Pushed </span><br><span class="line">b5432b464616: Pushed </span><br><span class="line">e6699b4fc2e3: Pushed </span><br><span class="line"><span class="number">762</span>ba19e7ef1: Pushed </span><br><span class="line">f2cb0ecef392: Pushed </span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# docker push <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/centos</span><br><span class="line">The push <span class="built_in">ref</span>ers to repository [<span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/centos]</span><br><span class="line"><span class="number">77</span>b174a6a187: Pushed </span><br><span class="line">[<span class="symbol">root@</span>localhost ~]# docker push <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/busybox</span><br><span class="line">The push <span class="built_in">ref</span>ers to repository [<span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/busybox]</span><br><span class="line">a6d503001157: Pushed</span><br></pre></td></tr></table></figure>
<p>查看上传后的私库中的镜像<br><code>192.168.1.12</code><br>查看到的镜像名和前面讲的是一样的</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@localhost</span> ~]<span class="meta"># curl 192.168.1.11:5000/v2/_catalog</span></span><br><span class="line">&#123;<span class="string">&quot;repositories&quot;</span>:[<span class="string">&quot;busybox&quot;</span>,<span class="string">&quot;centos&quot;</span>,<span class="string">&quot;httpd&quot;</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>下载镜像，速度相当快</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>localhost ~]# docker pull <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/httpd</span><br><span class="line"># 最后会输出下载地址</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/httpd:latest</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>:<span class="number">5000</span>/httpd:latest</span><br></pre></td></tr></table></figure>
<p><code>192.168.1.11</code><br>查看镜像映射到本地的存储目录</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls <span class="regexp">/opt/</span>data<span class="regexp">/registry/</span>docker<span class="regexp">/registry/</span>v2/<span class="keyword">repositories</span></span><br><span class="line">busybox  centos  httpd</span><br></pre></td></tr></table></figure>
<h6 id="查看仓库中镜像的信息"><a href="#查看仓库中镜像的信息" class="headerlink" title="查看仓库中镜像的信息"></a>查看仓库中镜像的信息</h6><p>查看httpd镜像的tags</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# curl <span class="number">192.168</span>.<span class="number">1.11</span>:<span class="number">5000</span><span class="regexp">/v2/</span>httpd<span class="regexp">/tags/</span>list</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;httpd&quot;</span>,<span class="string">&quot;tags&quot;</span>:[<span class="string">&quot;latest&quot;</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>查看镜像的hash值</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="number">192.168</span>.<span class="number">1.11</span>:<span class="number">5000</span><span class="regexp">/v2/</span>httpd<span class="regexp">/manifests/</span>latest \</span><br><span class="line">--header <span class="string">&quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot;</span></span><br><span class="line"># 找到第一个<span class="string">&quot;digest&quot;</span>:的值就是该镜像的hash值，以下的<span class="string">&quot;digest&quot;</span>:都是镜像层的hash值</span><br></pre></td></tr></table></figure>
<p>删除私库镜像</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 直接进入目录删除其中一个镜像的目录即可</span><br><span class="line">[root@localhost ~]# rm -rf <span class="regexp">/opt/</span>data<span class="regexp">/registry/</span>docker<span class="regexp">/registry/</span>v2<span class="regexp">/repositories/</span>httpd</span><br><span class="line">[root@localhost ~]# curl <span class="number">192.168</span>.<span class="number">1.11</span>:<span class="number">5000</span><span class="regexp">/v2/</span>_catalog</span><br><span class="line">&#123;<span class="string">&quot;repositories&quot;</span>:[<span class="string">&quot;busybox&quot;</span>,<span class="string">&quot;centos&quot;</span>]&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/10/Docker%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E9%80%BB%E8%BE%91%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="Semaik.">
      <meta itemprop="description" content="直到这一刻微笑着说话为止，我至少留下了一公升眼泪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Semaik.">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/10/Docker%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E9%80%BB%E8%BE%91%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Docker基础操作逻辑命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-10 17:08:00 / 修改时间：17:28:29" itemprop="dateCreated datePublished" datetime="2020-09-10T17:08:00+08:00">2020-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

     # 
     #
          <p><img src="/images/pasted-15.png" alt="upload successful"></p>
<p>镜像小的原因：<br>Linux操作系统两个部分构成内核空间（kernel）、用户空间（rootfs）</p>
<p>查看docker的基础信息</p>
<p><code>docker info</code></p>
<p>查看docker中已经存在的镜像</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line">参数：</span><br><span class="line">	-<span class="ruby">a：列出本地所有的镜像（含中间映像层）</span></span><br><span class="line"><span class="ruby">	-q：只显示镜像id</span></span><br><span class="line"><span class="ruby">	--digests：显示镜像的摘要信息</span></span><br><span class="line"><span class="ruby">	--no-trunc：显示完整的镜像信息</span></span><br></pre></td></tr></table></figure>



<p>在docker hub中查看关于该镜像的所有镜像</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">search</span></span><br><span class="line">例：</span><br><span class="line">docker <span class="built_in">search</span> ubuntu # 全网搜索ubuntu镜像</span><br></pre></td></tr></table></figure>

<p>下载镜像</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull 镜像名   //默认下载tomcat:latest，意思是最新版，或者tomcat:<span class="number">3</span>.<span class="number">2</span>  下载<span class="number">3</span>.<span class="number">2</span>版本</span><br></pre></td></tr></table></figure>

<p>删除镜像</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker rmi 镜像名： 删除镜像，默认删除 镜像名:latest，这个镜像不能在运行中</span><br><span class="line">docker rmi <span class="operator">-f</span> 镜像名：强制删除</span><br><span class="line">docker rmi <span class="operator">-f</span> <span class="variable">$</span>（docker images <span class="literal">-qa</span>）：删除全部镜像</span><br></pre></td></tr></table></figure>
<p>导出镜像</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">save</span> <span class="selector-tag">-o</span> 压缩包名称 镜像名称</span><br><span class="line">例：将镜像导出当前目录下</span><br><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">save</span> <span class="selector-tag">-o</span> <span class="selector-tag">centos</span><span class="selector-class">.tar</span> <span class="selector-tag">centos</span><span class="selector-pseudo">:latest</span></span><br><span class="line">将镜像<span class="selector-tag">centos</span><span class="selector-pseudo">:latest</span>另存到虚拟机当前目录下，命名为<span class="selector-tag">centos</span><span class="selector-class">.tar</span></span><br></pre></td></tr></table></figure>

<p>导入镜像</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">docker</span> <span class="selector-tag">load</span> &lt; <span class="selector-tag">centos</span><span class="selector-class">.tar</span></span><br></pre></td></tr></table></figure>
<p>重命名镜像名称</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">tag</span> <span class="title">旧镜像名称 新镜像名称</span></span><br><span class="line"><span class="title">例：</span></span><br><span class="line"><span class="title">docker</span> <span class="keyword">tag</span> <span class="title">500b941e6f79</span> tomcat7:jre7</span><br></pre></td></tr></table></figure>
<p>创建不运行容器</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">create</span> <span class="comment">--name web httpd</span></span><br></pre></td></tr></table></figure>
<p>创建并运行容器</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -p 88:80--name test --restart always centos:7 /bin/bash</span><br><span class="line">可用docker ps -a，查看容器运行状态</span><br><span class="line">参数：</span><br><span class="line">    -<span class="ruby">i  以交互方式登录</span></span><br><span class="line"><span class="ruby">    -t  允许以交互方式打开终端</span></span><br><span class="line"><span class="ruby">    -d  在后台运行</span></span><br><span class="line"><span class="ruby">    -p  映射端口，将容器中的<span class="number">80</span>端口映射成物理机中的<span class="number">88</span>端口</span></span><br><span class="line"><span class="ruby">    --name  添加容器名</span></span><br><span class="line"><span class="ruby">    --restart always  跟随docker启动而启动，就是当服务重启时、启动时，该容器也会运行</span></span><br><span class="line"><span class="ruby">    --rm  容器一旦停止就会被自动删除，不添加的话容器会永久保存在计算机中</span></span><br><span class="line"><span class="ruby">    --privileged  添加特权，不添加此参数 运行一些系统命令时错</span></span><br></pre></td></tr></table></figure>
<p>查看所有容器</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker ps -a</span></span><br></pre></td></tr></table></figure>
<p>立马强制性退出容器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">kill</span> 容器<span class="keyword">id</span></span><br></pre></td></tr></table></figure>
<p>停止容器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">stop</span> 容器<span class="keyword">id</span></span><br></pre></td></tr></table></figure>
<p>启动容器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">start</span> 容器<span class="keyword">id</span></span><br></pre></td></tr></table></figure>
<p>进入容器</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -<span class="keyword">it</span> 容器<span class="built_in">id</span> /bin/bash</span><br></pre></td></tr></table></figure>
<p>挂起容器</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pause 容器<span class="built_in">id</span></span><br></pre></td></tr></table></figure>
<p>取消挂起正常运行容器</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker unpause 容器<span class="built_in">id</span></span><br></pre></td></tr></table></figure>
<p>删除容器：（删除容器前需要停止容器）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> 容器id</span><br><span class="line">如：容器正在运行中需要删除容器，就需要添加参数<span class="operator">-f</span></span><br><span class="line">docker <span class="built_in">rm</span> <span class="operator">-f</span> 容器id</span><br></pre></td></tr></table></figure>
<p>查看容器信息</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 容器<span class="built_in">id</span></span><br></pre></td></tr></table></figure>
<p>编写进入容器脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/bin/docker-enter</span><br><span class="line">!/bin/sh</span><br><span class="line"><span class="keyword">if</span> [ -e $(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)/nsenter ]; <span class="keyword">then</span></span><br><span class="line"> with boot2docker, nsenter is not <span class="keyword">in</span> the PATH but it is <span class="keyword">in</span> the same folder</span><br><span class="line">  NSENTER=$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)/nsenter</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  NSENTER=nsenter</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Usage: `basename &quot;</span><span class="variable">$0</span><span class="string">&quot;` CONTAINER [COMMAND [ARG]...]&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Enters the Docker CONTAINER and executes the specified COMMAND.&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;If COMMAND is not specified, runs an interactive shell in CONTAINER.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  PID=$(docker inspect --format <span class="string">&quot;&#123;&#123;.State.Pid&#125;&#125;&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">shift</span></span><br><span class="line">  OPTS=<span class="string">&quot;--target <span class="variable">$PID</span> --mount --uts --ipc --net --pid --&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># No command given.</span></span><br><span class="line">    <span class="comment"># Use su to clear all host environment variables except for TERM,</span></span><br><span class="line">    <span class="comment"># initialize the environment variables HOME, SHELL, USER, LOGNAME, PATH,</span></span><br><span class="line">    <span class="comment"># and start a login shell.</span></span><br><span class="line">    <span class="string">&quot;<span class="variable">$NSENTER</span>&quot;</span> <span class="variable">$OPTS</span> su - root</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line">    <span class="comment"># Use env to clear all host environment variables.</span></span><br><span class="line">    <span class="string">&quot;<span class="variable">$NSENTER</span>&quot;</span> <span class="variable">$OPTS</span> env --ignore-environment -- <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>给予权限</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x <span class="regexp">/usr/</span>bin/docker-enter</span><br></pre></td></tr></table></figure>
<p>可以使用该脚本，加容器name或者容器id来启动容器</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-enter 容器<span class="built_in">id</span></span><br></pre></td></tr></table></figure>








<h5 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h5><p>虚拟机版本低于7.7，进如容器后无法使用网络，因为默认是关闭路由转发的，需要手动开启。<br>退出容器在宿主机执行以下操作：<br>echo “net.ipv4.ip_forward=1” &gt;&gt; /etc/sysctl.conf<br>sysctl -p</p>
<h5 id="提示："><a href="#提示：" class="headerlink" title="提示："></a>提示：</h5><p>进入任何一个容器中，所有命令不可以使用，环境比脸都干净，需要自己手动安装命令。<br>如果想使用某一条命令就执行 yum provides 命令  该命令搜查出命令对应的安装包，安装成功后命令即可使用。</p>
<p>如：<br>我想使用ifcofnig这条命令查看IP地址<br>安装前执行命令（报错：没有该命令）</p>
<p><img src="/images/pasted-16.png" alt="upload successful"></p>
<p>搜查命令对应的软件包</p>
<p><img src="/images/pasted-17.png" alt="upload successful"><br>安装软件包</p>
<p><img src="/images/pasted-18.png" alt="upload successful"><br>测试</p>
<p><img src="/images/pasted-19.png" alt="upload successful"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Semaik."
      src="/images/123.jpg">
  <p class="site-author-name" itemprop="name">Semaik.</p>
  <div class="site-description" itemprop="description">直到这一刻微笑着说话为止，我至少留下了一公升眼泪</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/semaik" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;semaik" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zuxuan8@aliyun.com" title="E-Mail → mailto:zuxuan8@aliyun.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Semaik.</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
